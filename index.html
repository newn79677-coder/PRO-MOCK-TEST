<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mock Test Pro - Enhanced</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#06b6d4" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Firebase SDKs v12 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification, updateProfile } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, orderBy, query, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCs2Ab_tFU18xj8o0qXuzIrphMT7OERNYY",
            authDomain: "practicpro-mock-0786.firebaseapp.com",
            projectId: "practicpro-mock-0786",
            storageBucket: "practicpro-mock-0786.firebasestorage.app",
            messagingSenderId: "457425256741",
            appId: "1:457425256741:web:0807a6c1333c8fb1c51acc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseStorage = storage;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            sendEmailVerification,
            updateProfile,
            collection,
            doc,
            setDoc,
            getDoc,
            getDocs,
            addDoc,
            orderBy,
            query,
            where,
            deleteDoc,
            ref,
            uploadBytes,
            getDownloadURL,
            deleteObject
        };
        
        // Initialize everything
document.addEventListener('DOMContentLoaded', () => {
    setupAutoSubmit();
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    }
});
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg: #0b1020;
            --card: #0f1724;
            --text: #e6eef8;
            --muted: #98a4b3;
            --primary: #06b6d4;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #24303f;
            --bg-secondary: #0b1220;
            --shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
            --border-radius: 12px;
        }

        [data-theme="light"] {
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1f2937;
            --muted: #6b7280;
            --primary: #4f46e5;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --border: #e5e7eb;
            --bg-secondary: #f1f5f9;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* App Header */
        .app-header {
            background: var(--card);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-logo {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), #8B5CF6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .app-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .menu-toggle:hover {
            background: var(--bg-secondary);
            color: var(--primary);
        }

        /* Menu Dropdown */
        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: none;
            min-width: 220px;
            z-index: 200;
            overflow: hidden;
            margin-top: 8px;
        }

        .menu-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .menu-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .menu-header h3 {
            color: var(--primary);
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .menu-item {
            display: block;
            padding: 12px 20px;
            color: var(--text);
            text-decoration: none;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
            color: var(--primary);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            padding: 8px 12px;
            color: var(--muted);
            cursor: pointer;
            min-width: 60px;
            transition: all 0.2s;
            border-radius: 12px;
        }

        .nav-item.active {
            color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 500;
        }

        /* Screen Management */
        .screen {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .card-header h2 {
            margin: 0 0 8px 0;
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        /* Dashboard */
        .dashboard-hero {
            background: linear-gradient(135deg, var(--primary), #8B5CF6);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
            color: white;
        }

        .hero-content {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .hero-text {
            flex: 1;
        }

        .hero-text h1 {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 4px 0;
        }

        .hero-text p {
            opacity: 0.9;
            margin: 0;
            font-size: 14px;
        }

        .hero-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .hero-stat {
            text-align: center;
        }

        .hero-stat-number {
            font-size: 20px;
            font-weight: bold;
            display: block;
        }

        .hero-stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        /* Action Cards */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .action-card {
            background: var(--card);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .action-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        .action-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--text);
        }

        .action-card p {
            color: var(--muted);
            font-size: 14px;
            margin: 0;
        }

        /* Test Interface */
        .test-container {
            max-height: 100vh;
            overflow: hidden;
        }

        .test-header {
            background: var(--card);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .test-progress {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-ring {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .progress-circle {
            width: 40px;
            height: 40px;
            transform: rotate(-90deg);
        }

        .progress-bg {
            fill: none;
            stroke: var(--border);
            stroke-width: 3;
        }

        .progress-fill {
            fill: none;
            stroke: var(--success);
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 113;
            stroke-dashoffset: 113;
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
            color: var(--text);
        }

        .test-timer {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            color: var(--primary);
        }

        .test-timer.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .test-timer.critical {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .test-actions {
            display: flex;
            gap: 8px;
        }

        .test-action-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .test-action-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Question Container */
        .question-container {
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .question-number {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .question-time-left {
            background: var(--warning);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .question-time-left.critical {
            background: var(--error);
            animation: pulse 1s infinite;
        }

        .question-marks {
            font-size: 14px;
            color: var(--muted);
        }

        .question-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 24px;
            color: var(--text);
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 80px;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card);
        }

        .option-item:hover {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }

        .option-item.selected {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.1);
        }

        .option-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .option-marker {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .option-item.selected .option-marker {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .option-text {
            flex: 1;
            line-height: 1.5;
        }

        /* Test Controls */
        .test-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 16px 20px;
            z-index: 50;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .control-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-btn.primary {
            background: var(--primary);
            color: white;
        }

        .control-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .control-btn.warning {
            background: var(--warning);
            color: white;
        }

        .control-btn.danger {
            background: var(--error);
            color: white;
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Question Palette Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(50px); }
            to { transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
            font-size: 18px;
            font-weight: 600;
        }

/* Add to your existing CSS */
#exit-test-btn {
    width: 100%;
    margin-top: 10px;
}

/* Ensure test controls have proper layout */
.test-controls {
    display: flex;
    flex-direction: column;
}

.control-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
}

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--muted);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: var(--bg-secondary);
        }

        .palette-legend {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.answered {
            background: var(--success);
        }

        .legend-color.marked {
            background: var(--warning);
        }

        .legend-color.visited {
            background: var(--error);
        }

        .legend-color.unvisited {
            background: var(--border);
        }

        .question-grid {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 12px;
        }

        .question-grid-btn {
            aspect-ratio: 1;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-grid-btn.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .question-grid-btn.marked {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .question-grid-btn.visited {
            background: var(--error);
            color: white;
            border-color: var(--error);
        }

        .question-grid-btn.current {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }

        .palette-summary {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            text-align: center;
        }

        .stat {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-count {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--muted);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            background: var(--card);
            color: var(--text);
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        /* Copy Button */
        .copy-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .copy-btn:hover {
            background: #d97706;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            color: var(--text);
            padding: 16px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            z-index: 1001;
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
            transition: all 0.3s ease;
            max-width: 90vw;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification.success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .notification.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Test Results */
        .result-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .download-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .download-btn:hover {
            background: #059669;
        }

        /* Schedule */
        .schedule-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
        }

        .schedule-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .schedule-content {
            color: var(--text);
            line-height: 1.5;
        }
/* ADD THIS CSS */
.schedule-entry {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.schedule-time {
    font-weight: 600;
    color: var(--primary);
}

 .schedule-expanded {
    max-height: none !important;
    overflow: visible !important;
}

.schedule-collapsed {
    max-height: 120px !important;
    overflow: hidden !important;
}       
/* Add to your existing CSS */
.study-points-card {
    background: linear-gradient(135deg, var(--primary), #8B5CF6);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    padding: 20px;
    text-align: center;
    margin-top: 20px;
}

.study-points-value {
    font-size: 32px;
    font-weight: bold;
    margin: 8px 0;
}

.study-points-label {
    opacity: 0.9;
    margin-bottom: 12px;
}

.study-points-rules {
    display: flex;
    justify-content: center;
    gap: 16px;
    font-size: 12px;
    opacity: 0.8;
}

        /* Notes List */
        .note-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .note-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        /* Profile Picture */
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin: 0 auto 20px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Test Mode Specific */
        .force-time-mode .question-time-left {
            display: block;
        }

        .force-time-mode .nav-btn {
            display: none;
        }

        .force-time-mode .test-controls {
            padding: 8px 16px;
        }

        /* Auto-lock expired question */
        .question-expired .options-container {
            opacity: 0.5;
            pointer-events: none;
        }

        .question-expired .question-text::after {
            content: ' (Time Expired)';
            color: var(--error);
            font-weight: bold;
        }

        /* Loading states */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
/* Add this to your existing CSS */
.notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: var(--card);
    color: var(--text);
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border: 2px solid var(--border);
    z-index: 1001;
    opacity: 0;
    transition: all 0.3s ease;
    max-width: 90vw;
    font-weight: 500;
    text-align: center;
}

.notification.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.notification.success {
    border-color: var(--success);
    background: var(--card);
    color: var(--success);
}

.notification.error {
    border-color: var(--error);
    background: var(--card);
    color: var(--error);
}

.notification.warning {
    border-color: var(--warning);
    background: var(--card);
    color: var(--warning);
}
        /* Responsive */
        @media (max-width: 768px) {
            .test-controls {
                padding: 12px 16px;
            }

            .control-btn {
                padding: 10px 12px;
                font-size: 13px;
            }

            .question-container {
                padding: 16px;
                max-height: calc(100vh - 300px);
            }

            .hero-stats {
                justify-content: center;
            }

            .action-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .result-actions {
                justify-content: center;
            }
        }

        /* Test fullscreen styles */
        .test-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-secondary);
            z-index: 9999;
        }

        .test-fullscreen .app-header,
        .test-fullscreen .bottom-nav {
            display: none;
        }
    </style>
    <!-- PATCH 1: Modal utilities -->
<script>
/* Modal utilities: openModal(id) and closeModal() */
function openModal(id) {
  const m = document.getElementById(id);
  if (!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  const focusEl = m.querySelector('button, [href], input, textarea, select');
  if (focusEl) focusEl.focus();
}

function closeModal() {
    // Find all open modals
    const openModals = document.querySelectorAll('.modal.show, .modal[aria-hidden="false"]');
    
    openModals.forEach(modal => {
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
    });
    
    document.body.style.overflow = '';
}

/* Close on overlay click & ESC */
document.addEventListener('click', (e) => {
  if (e.target && e.target.classList && e.target.classList.contains('modal')) {
    closeModal();
  }
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});
</script>
<!-- PATCH 2: Profile display & loadUserData -->
<script>
function updateProfileDisplay() {
  try {
    userProfile = userProfile || JSON.parse(localStorage.getItem('userProfile') || '{}') || {};
    const nameEl = document.getElementById('profile-display-name');
    const emailEl = document.getElementById('profile-display-email');
    const imgEl = document.getElementById('profile-picture');
    const initialEl = document.getElementById('profile-avatar-initial');

    if (nameEl) nameEl.textContent = userProfile.name || 'Guest User';
    if (emailEl) emailEl.textContent = userProfile.email || '';

    if (userProfile.profilePicture) {
      if (imgEl) { imgEl.src = userProfile.profilePicture; imgEl.style.display = 'block'; }
      if (initialEl) initialEl.style.display = 'none';
    } else {
      if (imgEl) imgEl.style.display = 'none';
      if (initialEl) {
        initialEl.style.display = 'flex';
        initialEl.textContent = (userProfile.name || 'U').charAt(0).toUpperCase();
      }
    }
  } catch (err) { console.warn('updateProfileDisplay error', err); }
}

async function loadUserData() {
  try {
    if (!window.firebaseAuth || !window.firebaseAuth.currentUser) return;
    const user = window.firebaseAuth.currentUser;
    userProfile.email = user.email || userProfile.email;
    userProfile.name = user.displayName || userProfile.name;

    if (window.firebaseFunctions && window.firebaseDB) {
      const udocRef = window.firebaseFunctions.doc(window.firebaseDB, 'users', user.uid);
      const snap = await window.firebaseFunctions.getDoc(udocRef).catch(()=>null);
      if (snap && snap.exists && snap.exists()) {
        Object.assign(userProfile, snap.data());
      }
    }
    localStorage.setItem('userProfile', JSON.stringify(userProfile));
    updateProfileDisplay();
  } catch (err) { console.warn('loadUserData error', err); }
}
</script>
</head>
<!-- Notification - Make sure this exists -->
<div class="notification" id="notification" aria-hidden="true">
    <span id="notification-text"></span>
</div>
<body data-theme="dark">
    <!-- App Header -->
    <header class="app-header">
        <div class="header-left">
            <div class="app-logo">📚</div>
            <h1 class="app-title">Mock Test Pro</h1>
        </div>
        <div class="header-right">
            <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        </div>
        
        <!-- Menu Dropdown -->
        <div class="menu-dropdown" id="menu-dropdown">
            <div class="menu-header">
                <h3>Mock Test Pro</h3>
            </div>
            <button class="menu-item" onclick="showScreen('dashboard')">🏠 Dashboard</button>
            <button class="menu-item" onclick="showScreen('my-tests')">📝 My Tests</button>
            <button class="menu-item" onclick="showScreen('results')">📊 Results</button>
            <button class="menu-item" onclick="showScreen('timetable')">📅 Schedule</button>
            <button class="menu-item" onclick="showScreen('notes')">📚 My Notes</button>
            <button class="menu-item" onclick="showScreen('profile')">👤 Profile</button>
            <button class="menu-item" id="auth-menu-item" onclick="showScreen('auth')">🔐 Login</button>
            <button class="menu-item" id="logout-menu-item" style="display:none;" onclick="logout()">🚪 Logout</button>
            <hr style="margin: 8px 0; border: none; border-top: 1px solid var(--border);">
            <button class="menu-item" onclick="toggleTheme()">
                <span id="theme-icon">☀️</span> Toggle Theme
            </button>
        </div>
    </header>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showScreen('dashboard')">
            <span class="nav-icon">🏠</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-item" onclick="showScreen('my-tests')">
            <span class="nav-icon">📝</span>
            <span class="nav-label">Tests</span>
        </button>
        <button class="nav-item" onclick="showScreen('results')">
            <span class="nav-icon">📊</span>
            <span class="nav-label">Results</span>
        </button>
        <button class="nav-item" onclick="showScreen('timetable')">
            <span class="nav-icon">📅</span>
            <span class="nav-label">Schedule</span>
        </button>
        <button class="nav-item" onclick="showScreen('notes')">
            <span class="nav-icon">📚</span>
            <span class="nav-label">Notes</span>
        </button>
    </nav>

<!-- Dashboard Screen -->
<div class="screen active" id="dashboard-screen">
    <div class="dashboard-hero">
        <div class="hero-content">
            <div class="hero-text">
                <h1>Welcome back, <span id="hero-name">Guest User</span>!</h1>
                <p id="hero-bio">Ready to ace your next test?</p>
            </div>
        </div>
        <div class="hero-stats">
            <div class="hero-stat">
                <span class="hero-stat-number" id="hero-tests">0</span>
                <span class="hero-stat-label">Tests Taken</span>
            </div>
            <div class="hero-stat">
                <span class="hero-stat-number" id="hero-avg">0%</span>
                <span class="hero-stat-label">Average Score</span>
            </div>
            <div class="hero-stat">
                <span class="hero-stat-number" id="hero-best">0%</span>
                <span class="hero-stat-label">Best Score</span>
            </div>
        </div>
    </div>

<!-- Today's Schedule Widget -->
    <div class="card" style="margin-bottom: 16px;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">Today's Schedule</h2>
            <button class="btn btn-secondary" onclick="toggleScheduleView()" style="padding: 8px 12px; font-size: 12px;">
                <span id="schedule-toggle-icon">👁️</span>
                <span id="schedule-toggle-text">Expand</span>
            </button>
        </div>
        <div class="card-body">
            <div id="todays-schedule" class="schedule-collapsed" style="color:var(--muted); min-height: 60px; max-height: 120px; overflow: hidden; transition: max-height 0.3s ease;">Loading...</div>
            <div style="margin-top: 12px;">
                <button class="btn btn-primary" onclick="showScreen('timetable')">View Full Schedule</button>
            </div>
        </div>
    </div>

    <!-- Action Grid (Create Test, My Tests, etc.) -->
    <div class="action-grid">
        <div class="action-card" onclick="showScreen('upload')">
            <span class="action-icon">📄</span>
            <h3>Create Test</h3>
            <p>Upload questions & start</p>
        </div>
        <div class="action-card" onclick="showScreen('my-tests')">
            <span class="action-icon">📚</span>
            <h3>My Tests</h3>
            <p>Access saved tests</p>
        </div>
        <div class="action-card" onclick="showScreen('results')">
            <span class="action-icon">📈</span>
            <h3>Results</h3>
            <p>View performance</p>
        </div>
        <div class="action-card" onclick="showScreen('timetable')">
            <span class="action-icon">📅</span>
            <h3>Schedule</h3>
            <p>Manage timetable</p>
        </div>
    </div>

    <!-- Study Points Widget - Added at the bottom -->
    <div class="card" style="margin-top: 20px; background: linear-gradient(135deg, var(--primary), #8B5CF6); color: white;">
        <div class="card-body" style="text-align: center;">
            <h2 style="margin-bottom: 8px;">Study Points</h2>

            <p style="margin-bottom: 12px; opacity: 0.9;">Earn points by studying daily</p>
            <div style="display: flex; justify-content: center; gap: 16px; font-size: 12px;">
                <div>🎯 3+ hours: 10 pts</div>
                <div>🔥 3.5+ hours: 15 pts</div>
                <div>⭐ 5+ hours: 30 pts</div>
            </div>
        </div>
    </div>
</div>
    <!-- Create Test Screen -->
    <div class="screen" id="upload-screen">
        <div class="card">
            <div class="card-header">
                <h2>Create New Test</h2>
                <p>Upload questions in JSON format</p>
            </div>
            <div class="card-body">
                <form id="test-form">
                    <div class="form-group">
                        <label class="form-label" for="test-title">Test Title</label>
                        <input type="text" id="test-title" class="form-input" placeholder="Enter test title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="test-duration">Duration (minutes)</label>
                        <input type="number" id="test-duration" class="form-input" value="60" min="5" required>
                    </div>
<div class="form-group">
    <label class="form-label" for="force-time-mode">Force Time Mode</label>
    <div style="display: flex; gap: 12px; align-items: center;">
        <input type="checkbox" id="force-time-mode">
        <input type="number" id="force-time-minutes" class="form-input" value="2" min="1" max="10" style="width: 80px;" placeholder="Minutes" disabled>
    </div>
    <small style="color: var(--muted); font-size: 12px;">Enable to set custom time per question (1–10 min).</small>
</div>
        
                    
                    <div class="form-group">
                        <label class="form-label" for="positive-marks">Positive Marks</label>
                        <input type="number" id="positive-marks" class="form-input" value="4" min="1" step="0.25" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="negative-marks">Negative Marks</label>
                        <input type="number" id="negative-marks" class="form-input" value="1" min="0" step="0.25" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="questions-json">
                            Questions JSON
                            <button type="button" class="copy-btn" onclick="copySampleJSON()">Copy Sample</button>
                        </label>
                        <textarea id="questions-json" class="form-input form-textarea" placeholder='Paste your questions JSON here...' required></textarea>
                    </div>
              <div style="margin-top:8px; color:var(--muted); font-size:13px;">
  Copy the sample JSON (button) → paste into any AI and ask it to produce questions in the same format. Then paste result into the Questions JSON box.
</div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-primary" onclick="loadQuestions()">Create Test</button>
                        <button type="button" class="btn btn-secondary" onclick="showScreen('dashboard')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Test Preview Screen -->
    <div class="screen" id="preview-screen">
        <div class="card">
            <div class="card-header">
                <h2 id="preview-title">Test Preview</h2>
                <p>Review test settings before starting</p>
            </div>
            <div class="card-body">
                <div id="test-preview-info"></div>
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showInstructions()">View Instructions & Start</button>
                    <button class="btn btn-secondary" onclick="showScreen('upload')">← Back to Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Screen -->
    <div class="screen" id="test-screen">
        <div class="test-container">
            <div class="test-header">
                <div class="test-progress">
                    <div class="progress-ring">
                        <svg class="progress-circle">
                            <circle class="progress-bg" cx="20" cy="20" r="18"></circle>
                            <circle class="progress-fill" cx="20" cy="20" r="18" id="progress-circle"></circle>
                        </svg>
                        <span class="progress-text" id="progress-text">1/10</span>
                    </div>
                </div>
                
                <div class="test-timer" id="main-timer">
                    <span>⏱️</span>
                    <span id="timer-display">60:00</span>
                </div>
                
              <div class="test-actions">
    <button class="test-action-btn" onclick="openQuestionPalette()">📋</button>
</div>  
            </div>
            
            <div class="question-container" id="question-container">
                <div class="question-header">
                    <span class="question-number" id="question-number">Question 1</span>
                    <span class="question-time-left" id="question-timer" style="display: none;">2:00</span>
                    <span class="question-marks" id="question-marks">+4, -1</span>
                </div>
                
                <div class="question-text" id="question-text">
                    Loading question...
                </div>
                
                <div class="options-container" id="options-container">
                    <!-- Options populated dynamically -->
                </div>
            </div>
            
            <div class="test-controls">
            	

                <div class="control-row">
                    <button class="control-btn secondary" onclick="clearResponse()">
                        🗑️ Clear
                    </button>
                    <button class="control-btn warning" onclick="markForReview()">
                        🏷️ Mark
                    </button>
                    <button class="control-btn primary" onclick="saveAndNext()">
                        ✓ Save & Next
                    </button>
                </div>
                <div class="control-row" id="navigation-controls">
    <button class="nav-btn" onclick="previousQuestion()" id="prev-btn">
        ← Previous
    </button>
    <button class="control-btn danger" onclick="submitTest()" id="submit-btn">
        Submit Test
    </button>
    <button class="nav-btn" onclick="nextQuestion()" id="next-btn">
        Next →
    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Tests Screen -->
    <div class="screen" id="my-tests-screen">
        <div class="card">
            <div class="card-header">
                <h2>My Tests</h2>
            </div>
            <div class="card-body" id="my-tests-content">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div class="screen" id="results-screen">
        <div class="card">
            <div class="card-header">
                <h2>Test Results</h2>
            </div>
            <div class="card-body" id="results-content">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Schedule Screen -->
    <div class="screen" id="timetable-screen">
        <div class="card">
            <div class="card-header">
                <h2>Study Schedule</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <button class="btn btn-primary" onclick="importSchedule()">Import Schedule (HTML)</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="timetable-date">Select Date</label>
                    <input type="date" id="timetable-date" class="form-input" value="">
                </div>
                <div class="form-group">
                    <label class="form-label" for="timetable-subject">Subject/Topic</label>
                    <input type="text" id="timetable-subject" class="form-input" placeholder="Enter subject or topic">
                </div>
                <div class="form-group">
                    <label class="form-label" for="timetable-time">Time (minutes)</label>
                    <input type="number" id="timetable-time" class="form-input" placeholder="Enter study time" min="15" step="15">
                </div>
                <button class="btn btn-primary" onclick="addTimetableItem()">Add to Schedule</button>
                
                <div id="timetable-list" style="margin-top: 20px;">
                    <!-- Timetable items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
<!-- Schedule Import Modal -->
    <div class="modal" id="schedule-import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Schedule</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p>Paste your HTML schedule content below:</p>
                <div class="form-group">
                    <textarea id="schedule-html" class="form-input form-textarea" placeholder="Paste your schedule HTML here..." style="min-height: 200px;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" onclick="importScheduleHTML()">Import Schedule</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- My Notes Screen -->
    <div class="screen" id="notes-screen">
        <div class="card">
            <div class="card-header">
                <h2>My Notes</h2>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <button class="btn btn-primary" onclick="createNote()">Create New Note</button>
                </div>
                
                <div id="notes-list" style="margin-top: 20px;">
                    <!-- Notes will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div class="screen" id="profile-screen">
        <div class="card">
            <div class="card-header">
                <h2>Profile</h2>
            </div>
            <div class="card-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="profile-avatar" onclick="changeProfilePicture()">
                        <img id="profile-picture" style="display: none;" alt="Profile Picture">
                        <span id="profile-avatar-initial">U</span>
                    </div>
                    <h3 id="profile-display-name">User Name</h3>
                    <p id="profile-display-email">user@example.com</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="profile-name">Full Name</label>
                 <input type="file" id="avatar-input" accept="image/*" style="display: none;">
   <input type="text" id="profile-name" class="form-input" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="profile-bio">Bio</label>
                    <textarea id="profile-bio" class="form-input form-textarea" placeholder="Tell us about yourself"></textarea>
                </div>
                <button class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
            </div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div class="screen" id="auth-screen">
        <div class="card">
            <div class="card-header">
                <h2>Login / Signup</h2>
            </div>
            <div class="card-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="switchAuthTab('login')">Login</div>
                    <div class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</div>
                </div>
                
                <form id="login-form" class="auth-form active">
                    <div class="form-group">
                        <label class="form-label" for="login-email">Email</label>
                        <input type="email" id="login-email" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="login-password">Password</label>
                        <input type="password" id="login-password" class="form-input" placeholder="Enter your password" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="login()">Login</button>
                </form>
                
                <form id="signup-form" class="auth-form">
                    <div class="form-group">
                        <label class="form-label" for="signup-name">Full Name</label>
                        <input type="text" id="signup-name" class="form-input" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signup-email">Email</label>
                        <input type="email" id="signup-email" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signup-password">Password</label>
                        <input type="password" id="signup-password" class="form-input" placeholder="Create a password" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signup-confirm-password">Confirm Password</label>
                        <input type="password" id="signup-confirm-password" class="form-input" placeholder="Confirm your password" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="signup()">Sign Up</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div class="modal" id="instructions-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Test Instructions</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div id="instruction-info"></div>
                <div style="margin: 20px 0;">
                    <h4>Instructions:</h4>
                    <ul>
                        <li>Read each question carefully before selecting an answer</li>
                        <li id="navigation-instruction">You can navigate between questions using Previous/Next buttons</li>
                        <li>Mark questions for review if you're unsure</li>
                        <li>You can change your answers anytime before submission</li>
                        <li>The test will auto-submit when time expires</li>
                        <li id="force-time-instruction" style="display: none; color: var(--error); font-weight: bold;">FORCE TIME MODE: You have exactly 2 minutes per question. When time expires, the question will be locked and you'll move to the next question automatically.</li>
                    </ul>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" onclick="startTestFromInstructions()">Start Test</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Palette Modal -->
    <div class="modal" id="question-palette-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Question Palette</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="palette-legend">
                <div class="legend-item">
                    <span class="legend-color answered"></span>
                    <span>Answered</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color marked"></span>
                    <span>Marked for Review</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color visited"></span>
                    <span>Not Answered</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color unvisited"></span>
                    <span>Not Visited</span>
                </div>
            </div>
            
            <div class="question-grid" id="question-palette-grid">
                <!-- Questions populated dynamically -->
            </div>
            
            <div class="palette-summary">
                <div class="summary-stats">
                    <div class="stat">
                        <span class="stat-count" id="answered-count">0</span>
                        <span class="stat-label">Answered</span>
                    </div>
                    <div class="stat">
                        <span class="stat-count" id="marked-count">0</span>
                        <span class="stat-label">Marked</span>
                    </div>
                    <div class="stat">
                        <span class="stat-count" id="not-answered-count">0</span>
                        <span class="stat-label">Not Answered</span>
                    </div>
                    <div class="stat">
                        <span class="stat-count" id="unvisited-count">0</span>
                        <span class="stat-label">Not Visited</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Submit Modal -->
<div class="modal" id="submit-modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Submit Test?</h3>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    <div style="padding: 20px;">
      <p style="margin-bottom: 16px;">
        Are you sure you want to submit the test? You cannot make changes after submission.
      </p>
      <div id="submit-summary" 
           style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <!-- Summary populated dynamically -->
      </div>
      <div style="display: flex; gap: 12px; justify-content: center;">
        <button class="btn btn-danger" onclick="finalSubmitTest()">Submit Test</button>
        <button class="btn btn-secondary" onclick="closeModal()">Continue Test</button>
      </div>
    </div>
  </div>
</div>

<!-- PATCH 3A: Reading mode modal -->
<div class="modal" id="note-reading-modal" aria-hidden="true">
  <div class="modal-content" style="max-width: 1000px; width: 100%; height: 90vh;">
    <div class="modal-header">
      <h3 id="reading-title">Reading</h3>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="reading-body" style="height: calc(90vh - 120px); overflow: auto; padding: 12px;">
      <!-- iframe will be injected here -->
    </div>
    <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:8px;">
      <button class="btn btn-secondary" onclick="closeModal()">Back</button>
    </div>
  </div>
</div>

    <!-- Notes Creation Modal -->
    <div class="modal" id="note-creation-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Note</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label class="form-label" for="note-title">Note Title</label>
                    <input type="text" id="note-title" class="form-input" placeholder="Enter note title">
                </div>
                <div class="form-group">
                    <label class="form-label" for="note-html">Note Content (HTML)</label>
                    <textarea id="note-html" class="form-input form-textarea" placeholder="Paste your HTML content here..." style="min-height: 200px;"></textarea>
                </div>
                <!-- PATCH 4A: AI prompt helper -->
<div style="margin-top:12px; background:var(--bg-secondary); padding:12px; border-radius:8px;">
  <div style="font-weight:600; margin-bottom:6px;">AI prompt — copy & paste to any AI</div>
  <div style="display:flex; gap:8px;">
    <input id="ai-notes-prompt" class="form-input" 
           value="Generate notes on [TOPIC] in HTML + CSS format. Use headings, bullets, small code blocks and a short summary at the end." 
           style="flex:1;">
    <button class="copy-btn" type="button" onclick="copyToClipboard('#ai-notes-prompt')">Copy</button>
  </div>
  <div style="color:var(--muted); font-size:12px; margin-top:6px;">
    Tip: replace <code>[TOPIC]</code> with your subject e.g. "Coordinate Geometry — Triangles".
  </div>
</div>
                
           <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Import Modal -->
    <div class="modal" id="schedule-import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import Schedule</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p>Paste your HTML schedule content below:</p>
                <div class="form-group">
                    <textarea id="schedule-html" class="form-input form-textarea" placeholder="Paste your schedule HTML here..." style="min-height: 200px;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" onclick="importScheduleHTML()">Import Schedule</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Hidden file input for profile picture -->
    <input type="file" id="avatar-input" accept="image/*" style="display: none;">

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notification-text"></span>
    </div>
<!-- PATCH 3B: Notes listing + Reading Mode -->
<script>
function loadNotes() {
  const list = document.getElementById('notes-list');
  if (!list) return;
  if (!Array.isArray(notes) || notes.length === 0) {
    list.innerHTML = `
      <div style="text-align:center; padding:20px;">
        <p style="color:var(--muted)">No notes created yet.</p>
        <p style="color:var(--muted); font-size:12px;">Create your first note to get started.</p>
      </div>
    `;
    return;
  }

  let html = '<div style="display:flex; flex-direction:column; gap:12px;">';
  notes.forEach((note, index) => {
    html += `
      <div class="note-item">
        <div class="note-title">${note.title}</div>
        <div style="color:var(--muted); font-size:12px; margin-top:6px;">
          Created: ${new Date(note.date).toLocaleString()}
          <div style="float:right; display:flex; gap:8px;">
            <button class="btn btn-primary" onclick="openNoteReading(${index}); event.stopPropagation();" style="padding:6px 10px; font-size:12px;">Read</button>
            <button class="btn btn-danger" onclick="event.stopPropagation(); deleteNote(${index})" style="padding:6px 10px; font-size:12px;">Delete</button>
          </div>
        </div>
      </div>
    `;
  });
  html += '</div>';
  list.innerHTML = html;
}

function openNoteReading(index) {
  const note = notes[index];
  if (!note) return showNotification('Note not found','error');
  document.getElementById('reading-title').textContent = note.title || 'Reading';
  const container = document.getElementById('reading-body');
  container.innerHTML = '';

  const iframe = document.createElement('iframe');
  iframe.style.width = '100%';
  iframe.style.height = '100%';
  iframe.style.border = 'none';
  iframe.setAttribute('sandbox', ''); // safe: no scripts
  iframe.srcdoc = note.html || `<pre>${escapeHtml(note.html || '')}</pre>`;

  container.appendChild(iframe);
  openModal('note-reading-modal');
}

function escapeHtml(s){ 
  return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); 
}
</script>

    <script>
        // Global variables
        let currentTest = null;
        let currentQuestion = 0;
        let userAnswers = {};
        let questionStatus = {};
        let testTimer = null;
        let questionTimer = null;
        let timeRemaining = 0;
        let questionTimeRemaining = 0;
        let savedTests = [];
        let testResults = [];
        let notes = [];
        let schedule = [];
        let isPaused = false;
        let forceTimeMode = false;
        let questionLocked = false;
        let userProfile = {
            name: 'Guest User',
            email: '',
            bio: 'Ready to ace your next test?',
            profilePicture: null
            
        };
        
<!-- PATCH 5B: Sample JSON variable -->
const sampleJSON = `[
  {
    "q": "What is 2 + 2?",
    "options": ["2", "3", "4", "5"],
    "answer": "4",
    "explanation": "Basic addition: 2 + 2 = 4"
  },
  {
    "q": "Which planet is known as the Red Planet?",
    "options": ["Earth", "Venus", "Mars", "Jupiter"],
    "answer": "Mars",
    "explanation": "Mars is called the Red Planet due to its iron oxide surface."
  }
   
]`;
// This is the NEW, corrected function
function initApp() {
    loadSavedData();
    updateProfileDisplay();
    setupEventListeners();
    showNotification('Welcome to Mock Test Pro!', 'success');
    
    // Firebase auth listener
    if (window.firebaseFunctions) {
        window.firebaseFunctions.onAuthStateChanged(window.firebaseAuth, (user) => {
            if (user) {
                userProfile.email = user.email;
                userProfile.name = user.displayName || userProfile.name;
                updateAuthUI(true);
            } else {
                updateAuthUI(false);
            }
        });
    }

    setupEventListeners();
    loadTodaysSchedule(); 
    
    function updateStudyPoints() {
    const today = new Date().toISOString().split('T')[0];
    const completedToday = getCompletedTasksForDate(today);
    
    let points = 0;
    if (completedToday >= 5) points = 30;
    else if (completedToday >= 3) points = 15;
    else if (completedToday >= 2) points = 10;
    
    const pointsEl = document.getElementById('study-points-count');
    if (pointsEl) {
        pointsEl.textContent = points;
    }
}
}


        // Setup event listeners
        function setupEventListeners() {
            // Load current date for timetable
            document.getElementById('timetable-date').valueAsDate = new Date();
            
            // Handle theme from localStorage
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            }
            
            // Close modals on outside click
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal();
                }
                if (!e.target.closest('.header-right') && !e.target.closest('.menu-dropdown')) {
                    closeMenu();
                }
            });
            
            // Handle avatar upload
            const avatarInput = document.getElementById('avatar-input');
            if (avatarInput) {
                avatarInput.addEventListener('change', handleAvatarUpload);
            }
        }

        // Copy sample JSON function
        function copySampleJSON() {
            navigator.clipboard.writeText(sampleJSON).then(() => {
                showNotification('Sample JSON copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = sampleJSON;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Sample JSON copied!', 'success');
            });
        }

        // Handle avatar upload
        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageUrl = event.target.result;
                
                // Update all profile images
                document.getElementById('profile-picture').src = imageUrl;
                document.getElementById('profile-picture').style.display = 'block';
                document.getElementById('profile-avatar-initial').style.display = 'none';
                
                // Save to profile
                userProfile.profilePicture = imageUrl;
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                
                showNotification('Profile picture updated!', 'success');
            };
            reader.readAsDataURL(file);
        }

        // Data management
        // This is the NEW, corrected function
function loadSavedData() {
    try {
        savedTests = JSON.parse(localStorage.getItem('mockTests') || '[]');
        testResults = JSON.parse(localStorage.getItem('testResults') || '[]');
        userProfile = JSON.parse(localStorage.getItem('userProfile') || JSON.stringify(userProfile));
        notes = JSON.parse(localStorage.getItem('notes') || '[]');
        schedule = JSON.parse(localStorage.getItem('schedule') || '[]');
        completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '{}'); // ADD THIS LINE
    } catch (e) {
        console.error('Error loading saved data:', e);
        // Reset data if corrupted
        savedTests = [];
        testResults = [];
        notes = [];
        schedule = [];
        completedTasks = {}; // ADD THIS LINE
        localStorage.setItem('mockTests', '[]');
        localStorage.setItem('testResults', '[]');
        localStorage.setItem('notes', '[]');
        localStorage.setItem('schedule', '[]');
        localStorage.setItem('completedTasks', '{}'); // ADD THIS LINE
    }
}

        function loadUserData() {
            // Load user-specific data from Firebase if logged in
            if (window.firebaseAuth.currentUser) {
                const userId = window.firebaseAuth.currentUser.uid;
                
                // Load user profile from Firestore
                window.firebaseFunctions.getDoc(window.firebaseFunctions.doc(window.firebaseDB, 'users', userId))
                    .then((doc) => {
                        if (doc.exists()) {
                            const userData = doc.data();
                            userProfile = {...userProfile, ...userData};
                            localStorage.setItem('userProfile', JSON.stringify(userProfile));
                            updateProfileDisplay();
                        }
                    })
                    .catch((error) => {
                        console.error('Error loading user data:', error);
                    });
            }
        }

        function updateProfileDisplay() {
            const initial = userProfile.name.charAt(0).toUpperCase();
            
            // Update profile initial
            document.getElementById('profile-avatar-initial').textContent = initial;
            
            // Update names and bio
            document.getElementById('hero-name').textContent = userProfile.name;
            document.getElementById('hero-bio').textContent = userProfile.bio;
            document.getElementById('profile-display-name').textContent = userProfile.name;
            document.getElementById('profile-display-email').textContent = userProfile.email || 'Email not set';
            
            // Update profile form
            document.getElementById('profile-name').value = userProfile.name;
            document.getElementById('profile-bio').value = userProfile.bio || '';
            
            // Update profile picture if available
            if (userProfile.profilePicture) {
                document.getElementById('profile-picture').src = userProfile.profilePicture;
                document.getElementById('profile-picture').style.display = 'block';
                document.getElementById('profile-avatar-initial').style.display = 'none';
            }
            
            // Update stats
            const testsTaken = testResults.length;
            const avgScore = testsTaken > 0 ? Math.round(testResults.reduce((sum, r) => sum + r.percentage, 0) / testsTaken) : 0;
            const bestScore = testsTaken > 0 ? Math.max(...testResults.map(r => r.percentage)) : 0;
            
            document.getElementById('hero-tests').textContent = testsTaken;
            document.getElementById('hero-avg').textContent = avgScore + '%';
            document.getElementById('hero-best').textContent = bestScore + '%';
        }

        // Navigation functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            document.getElementById(screenId + '-screen').classList.add('active');
            
            // Update bottom nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navIndex = getNavIndex(screenId);
            if (navIndex !== -1) {
                document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            }
            
            // Load screen-specific content
            switch(screenId) {
                case 'my-tests':
                    loadMyTests();
                    break;
                case 'results':
                    loadResults();
                    break;
                case 'timetable':
                    loadTimetable();
                    break;
                case 'notes':
                    loadNotes();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }
            
            closeMenu();
        }

        function getNavIndex(screenId) {
            const navMap = {
                'dashboard': 0,
                'my-tests': 1,
                'results': 2,
                'timetable': 3,
                'notes': 4
            };
            return navMap[screenId] ?? -1;
        }

        function toggleMenu() {
            const menu = document.getElementById('menu-dropdown');
            menu.classList.toggle('show');
        }

        function closeMenu() {
            document.getElementById('menu-dropdown').classList.remove('show');
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('theme-icon').textContent = isDark ? '🌙' : '☀️';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
            closeMenu();
        }

        // Auth Tab Styles
        const authTabStyles = `
            .auth-tabs {
                display: flex;
                border-bottom: 1px solid var(--border);
                margin-bottom: 20px;
            }
            
            .auth-tab {
                flex: 1;
                padding: 12px;
                text-align: center;
                cursor: pointer;
                border-bottom: 2px solid transparent;
            }
            
            .auth-tab.active {
                border-bottom-color: var(--primary);
                color: var(--primary);
                font-weight: 600;
            }
            
            .auth-form {
                display: none;
            }
            
            .auth-form.active {
                display: block;
            }
        `;
        
        // Add styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = authTabStyles;
        document.head.appendChild(styleSheet);

        // Authentication functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
            document.getElementById(`${tab}-form`).classList.add('active');
        }

        function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }
            
            showNotification('Logging in...', 'success');
            
            window.firebaseFunctions.signInWithEmailAndPassword(window.firebaseAuth, email, password)
                .then((userCredential) => {
                    showNotification('Logged in successfully!', 'success');
                    updateAuthUI(true);
                    showScreen('dashboard');
                })
                .catch((error) => {
                    showNotification('Login failed: ' + error.message, 'error');
                });
        }

        function signup() {
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            
            if (!name || !email || !password || !confirmPassword) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }
            
            showNotification('Creating account...', 'success');
            
            window.firebaseFunctions.createUserWithEmailAndPassword(window.firebaseAuth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    return window.firebaseFunctions.updateProfile(user, {
                        displayName: name
                    }).then(() => {
                        return window.firebaseFunctions.sendEmailVerification(user);
                    }).then(() => {
                        showNotification('Account created! Please verify your email.', 'success');
                        userProfile.name = name;
                        userProfile.email = email;
                        updateAuthUI(true);
                        showScreen('dashboard');
                    });
                })
                .catch((error) => {
                    showNotification('Signup failed: ' + error.message, 'error');
                });
        }

        function logout() {
            showNotification('Logging out...', 'success');
            
            window.firebaseFunctions.signOut(window.firebaseAuth)
                .then(() => {
                    showNotification('Logged out successfully', 'success');
                    userProfile.email = '';
                    updateAuthUI(false);
                    showScreen('auth');
                })
                .catch((error) => {
                    showNotification('Logout failed: ' + error.message, 'error');
                });
        }

        function updateAuthUI(isLoggedIn) {
            document.getElementById('auth-menu-item').style.display = isLoggedIn ? 'none' : 'block';
            document.getElementById('logout-menu-item').style.display = isLoggedIn ? 'block' : 'none';
        }

        // Test functionality
        function loadQuestions() {
            const title = document.getElementById('test-title').value.trim();
            const duration = parseInt(document.getElementById('test-duration').value);
            const positiveMarks = parseFloat(document.getElementById('positive-marks').value);
            const negativeMarks = parseFloat(document.getElementById('negative-marks').value);
            const jsonText = document.getElementById('questions-json').value.trim();
            forceTimeMode = document.getElementById('force-time-mode').checked;

            if (!title || !duration || !jsonText) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            try {
                const questions = JSON.parse(jsonText);
                if (!Array.isArray(questions) || questions.length === 0) {
                    throw new Error('Invalid format - must be array of questions');
                }
questions.forEach((q, i) => {
    if (!q.question || !Array.isArray(q.options) || typeof q.correct !== 'number') {
        throw new Error(`Invalid question ${i + 1} - missing required fields`);
    }
    // Optional: Add explanation if not present
    if (!q.explanation) {
        q.explanation = "No explanation provided for this question.";
    }
                
                });

                currentTest = {
                    id: Date.now(),
                    title,
                    duration,
                    positiveMarks,
                    negativeMarks,
                    questions,
                    forceTimeMode,
                    created: new Date().toISOString()
                };

                showTestPreview();
                showNotification('Test created successfully!', 'success');
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function showTestPreview() {
            showScreen('preview');
            document.getElementById('preview-title').textContent = currentTest.title;
            
            const totalMarks = currentTest.questions.length * currentTest.positiveMarks;
            const modeText = currentTest.forceTimeMode ? 'Force Time Mode (2 min per question)' : 'Normal Mode';
            
            document.getElementById('test-preview-info').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin: 16px 0;">
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">${currentTest.questions.length}</span>
                        <span style="font-size: 12px; color: var(--muted);">Questions</span>
                    </div>
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">${currentTest.duration} min</span>
                        <span style="font-size: 12px; color: var(--muted);">Duration</span>
                    </div>
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">${totalMarks}</span>
                        <span style="font-size: 12px; color: var(--muted);">Total Marks</span>
                    </div>
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">+${currentTest.positiveMarks}/-${currentTest.negativeMarks}</span>
                        <span style="font-size: 12px; color: var(--muted);">Marking</span>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 16px; padding: 12px; background: ${currentTest.forceTimeMode ? 'rgba(239, 68, 68, 0.1)' : 'var(--bg-secondary)'}; border-radius: 8px;">
                    <strong>${modeText}</strong>
                </div>
            `;
        }

        function showInstructions() {
            const modal = document.getElementById('instructions-modal');
            modal.classList.add('show');
            
            // Update instruction info
            document.getElementById('instruction-info').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">${currentTest.questions.length}</span>
                        <span style="font-size: 12px; color: var(--muted);">Total Questions</span>
                    </div>
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">${currentTest.duration} min</span>
                        <span style="font-size: 12px; color: var(--muted);">Time Duration</span>
                    </div>
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">${currentTest.questions.length * currentTest.positiveMarks}</span>
                        <span style="font-size: 12px; color: var(--muted);">Maximum Marks</span>
                    </div>
                    <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary); display: block;">MCQ</span>
                        <span style="font-size: 12px; color: var(--muted);">Question Type</span>
                    </div>
                </div>
            `;
            
            // Show/hide force time instruction
            if (currentTest.forceTimeMode) {
                document.getElementById('force-time-instruction').style.display = 'block';
                document.getElementById('navigation-instruction').style.display = 'none';
            } else {
                document.getElementById('force-time-instruction').style.display = 'none';
                document.getElementById('navigation-instruction').style.display = 'block';
            }
        }

        function startTestFromInstructions() {
            closeModal();
            startTest();
        }

        function startTest() {
            // Initialize test state
            currentQuestion = 0;
            userAnswers = {};
            questionStatus = {};
            timeRemaining = currentTest.duration * 60;
            const forcedTime = getForcedTimeMinutes();
questionTimeRemaining = (currentTest.forceTimeMode && forcedTime !== null) ? forcedTime * 60 : 0;
            isPaused = false;
            questionLocked = false;

            // Initialize question status
            currentTest.questions.forEach((_, i) => {
                questionStatus[i] = 'unvisited';
            });

            // Save test
            if (!savedTests.find(t => t.id === currentTest.id)) {
                savedTests.push(currentTest);
                localStorage.setItem('mockTests', JSON.stringify(savedTests));
            }

            // Enter fullscreen mode
            enterTestFullscreen();
            
            showScreen('test');
            loadCurrentQuestion();
            startTimer();
            updateProgress();
            
            // Setup force time mode UI
            if (currentTest.forceTimeMode) {
                document.querySelector('.test-container').classList.add('force-time-mode');
                document.getElementById('navigation-controls').style.display = 'none';
                document.getElementById('question-timer').style.display = 'block';
                startQuestionTimer();
            }
            
            showNotification('Test started! Good luck!', 'success');
        }

        function enterTestFullscreen() {
            const testContainer = document.querySelector('.test-container');
            if (testContainer) {
                testContainer.classList.add('test-fullscreen');
            }
            
            // Hide navigation elements during test
            document.querySelector('.app-header').style.display = 'none';
            document.querySelector('.bottom-nav').style.display = 'none';
        }

        function exitTestFullscreen() {
            const testContainer = document.querySelector('.test-container');
            if (testContainer) {
                testContainer.classList.remove('test-fullscreen');
            }
            
            // Show navigation elements
            document.querySelector('.app-header').style.display = 'flex';
            document.querySelector('.bottom-nav').style.display = 'flex';
        }

        function startTimer() {
            clearInterval(testTimer);
            testTimer = setInterval(() => {
                if (isPaused) return;
                
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(testTimer);
                    autoSubmitTest();
                }
            }, 1000);
        }

        function startQuestionTimer() {
            if (!currentTest.forceTimeMode) return;
            
            questionTimeRemaining = 120; // 2 minutes
            clearInterval(questionTimer);
            
            questionTimer = setInterval(() => {
                if (isPaused || questionLocked) return;
                
                questionTimeRemaining--;
                updateQuestionTimerDisplay();
                
                if (questionTimeRemaining <= 0) {
                    lockCurrentQuestion();
                    autoNextQuestion();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
            
            // Change color when time is running low
            const timerEl = document.getElementById('main-timer');
            if (timeRemaining <= 300) { // Last 5 minutes
                timerEl.classList.add('critical');
            } else if (timeRemaining <= 600) { // Last 10 minutes
                timerEl.classList.add('warning');
            }
        }

        function updateQuestionTimerDisplay() {
            if (!currentTest.forceTimeMode) return;
            
            const minutes = Math.floor(questionTimeRemaining / 60);
            const seconds = questionTimeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('question-timer').textContent = display;
            
            // Change color when time is running low
            const timerEl = document.getElementById('question-timer');
            if (questionTimeRemaining <= 30) { // Last 30 seconds
                timerEl.classList.add('critical');
            }
        }

        function lockCurrentQuestion() {
            questionLocked = true;
            document.getElementById('question-container').classList.add('question-expired');
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.add('locked');
            });
        }

        function autoNextQuestion() {
            setTimeout(() => {
                if (currentQuestion < currentTest.questions.length - 1) {
                    currentQuestion++;
                    loadCurrentQuestion();
                } else {
                    autoSubmitTest();
                }
            }, 1000);
        }

        function loadCurrentQuestion() {
            if (!currentTest || !currentTest.questions[currentQuestion]) return;
            
            questionLocked = false;
            document.getElementById('question-container').classList.remove('question-expired');
            
            const question = currentTest.questions[currentQuestion];
            
            // Mark as visited if not already
            if (questionStatus[currentQuestion] === 'unvisited') {
                questionStatus[currentQuestion] = 'visited';
            }
            
            // Update question display
            document.getElementById('question-number').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('question-marks').textContent = `+${currentTest.positiveMarks}, -${currentTest.negativeMarks}`;
            document.getElementById('question-text').innerHTML = question.question.replace(/\n/g, '<br>');
            
            // Load options
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `option-item ${userAnswers[currentQuestion] === index ? 'selected' : ''}`;
                optionDiv.onclick = () => selectOption(index);
                
                optionDiv.innerHTML = `
                    <span class="option-marker">${String.fromCharCode(65 + index)}</span>
                    <span class="option-text">${option}</span>
                `;
                
                container.appendChild(optionDiv);
            });
            
            // Update navigation buttons for normal mode
            if (!currentTest.forceTimeMode) {
                document.getElementById('prev-btn').disabled = currentQuestion === 0;
                document.getElementById('next-btn').disabled = currentQuestion === currentTest.questions.length - 1;
            }
            
            // Start question timer for force time mode
            if (currentTest.forceTimeMode) {
                startQuestionTimer();
            }
            
            updateProgress();
        }

        function selectOption(index) {
            if (questionLocked) return;
            
            userAnswers[currentQuestion] = index;
            questionStatus[currentQuestion] = 'answered';
            
            // Update UI
            document.querySelectorAll('.option-item').forEach((item, i) => {
                item.classList.toggle('selected', i === index);
            });
            
            updateProgress();
        }

        function previousQuestion() {
            if (currentTest.forceTimeMode || currentQuestion <= 0) return;
            currentQuestion--;
            loadCurrentQuestion();
        }

        function nextQuestion() {
            if (currentTest.forceTimeMode || currentQuestion >= currentTest.questions.length - 1) return;
            currentQuestion++;
            loadCurrentQuestion();
        }

        function saveAndNext() {
            if (currentQuestion < currentTest.questions.length - 1) {
                currentQuestion++;
                loadCurrentQuestion();
            } else {
                showSubmitModal();
            }
        }

        function clearResponse() {
            if (questionLocked) return;
            
            delete userAnswers[currentQuestion];
            questionStatus[currentQuestion] = 'visited';
            
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateProgress();
            showNotification('Response cleared', 'success');
        }

        function markForReview() {
            if (currentTest.forceTimeMode) return; // Can't mark for review in force time mode
            
            if (questionStatus[currentQuestion] === 'marked') {
                questionStatus[currentQuestion] = userAnswers[currentQuestion] !== undefined ? 'answered' : 'visited';
                showNotification('Question unmarked for review', 'success');
            } else {
                questionStatus[currentQuestion] = 'marked';
                showNotification('Question marked for review', 'success');
            }
            updateProgress();
        }

        function pauseTest() {
            if (currentTest.forceTimeMode) {
                showNotification('Cannot pause in Force Time Mode', 'error');
                return;
            }
            
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pause-btn');
            
            if (isPaused) {
                pauseBtn.textContent = '▶️';
                showNotification('Test paused', 'warning');
            } else {
                pauseBtn.textContent = '⏸️';
                showNotification('Test resumed', 'success');
            }
        }
function exitTest() {
    if (confirm('Are you sure you want to exit the test? Your progress will be lost.')) {
        clearInterval(testTimer);
        clearInterval(questionTimer);
        exitTestFullscreen();
        currentTest = null;
        showScreen('dashboard');
        showNotification('Test exited', 'warning');
    }
}
        function updateProgress() {
            if (!currentTest) return;
            
            const answered = Object.keys(userAnswers).length;
            const total = currentTest.questions.length;
            const percentage = (answered / total) * 100;
            
            // Update progress text
            document.getElementById('progress-text').textContent = `${currentQuestion + 1}/${total}`;
            
            // Update progress circle
            const circumference = 2 * Math.PI * 18; // radius = 18
            const offset = circumference - (percentage / 100) * circumference;
            document.getElementById('progress-circle').style.strokeDashoffset = offset;
        }

        function openQuestionPalette() {
            if (currentTest.forceTimeMode) {
                showNotification('Question palette not available in Force Time Mode', 'error');
                return;
            }
            
            const modal = document.getElementById('question-palette-modal');
            modal.classList.add('show');
            renderQuestionPalette();
        }

        function renderQuestionPalette() {
            const grid = document.getElementById('question-palette-grid');
            grid.innerHTML = '';
            
            let answered = 0, marked = 0, notAnswered = 0, unvisited = 0;
            
            currentTest.questions.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = 'question-grid-btn';
                btn.textContent = index + 1;
                btn.onclick = () => goToQuestion(index);
                
                // Determine status
                let status = 'unvisited';
                if (userAnswers[index] !== undefined) {
                    status = 'answered';
                    answered++;
                } else if (questionStatus[index] === 'marked') {
                    status = 'marked';
                    marked++;
                } else if (questionStatus[index] === 'visited') {
                    status = 'visited';
                    notAnswered++;
                } else {
                    unvisited++;
                }
                
                btn.classList.add(status);
                
                if (index === currentQuestion) {
                    btn.classList.add('current');
                }
                
                grid.appendChild(btn);
            });
            
            // Update summary stats
            document.getElementById('answered-count').textContent = answered;
            document.getElementById('marked-count').textContent = marked;
            document.getElementById('not-answered-count').textContent = notAnswered;
            document.getElementById('unvisited-count').textContent = unvisited;
        }

        function goToQuestion(index) {
            if (currentTest.forceTimeMode) return; // Can't navigate freely in force time mode
            currentQuestion = index;
            closeModal();
            loadCurrentQuestion();
        }

        // REPLACE your old showSubmitModal function with this new one
function showSubmitModal() {
    if (confirm('Are you sure you want to submit the test? You cannot make changes after submission.')) {
        submitTest();
    }

    // Calculate summary
    const answered = Object.keys(userAnswers).length;
    const total = currentTest.questions.length;
    const marked = Object.values(questionStatus).filter(s => s === 'marked').length;
    const unvisited = Object.values(questionStatus).filter(s => s === 'unvisited').length;
    const notAnswered = total - answered - unvisited;
    
    // Update summary
    const summaryEl = document.getElementById('submit-summary');
    if (summaryEl) {
        summaryEl.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                <div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--success);">${answered}</div>
                    <div style="font-size: 12px; color: var(--muted);">Answered</div>
                </div>
                <div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--warning);">${marked}</div>
                    <div style="font-size: 12px; color: var(--muted);">Marked</div>
                </div>
                <div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--error);">${notAnswered}</div>
                    <div style="font-size: 12px; color: var(--muted);">Not Answered</div>
                </div>
                <div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--muted);">${unvisited}</div>
                    <div style="font-size: 12px; color: var(--muted);">Not Visited</div>
                </div>
            </div>
        `;
    }
}
function finalSubmitTest() {
    // Close modal first
    closeModal();
    
    // Submit test
    setTimeout(() => {
        submitTest();
    }, 100);
}
        function autoSubmitTest() {
            clearInterval(testTimer);
            clearInterval(questionTimer);
            submitTest();
            showNotification('Test auto-submitted due to time expiry!', 'warning');
        }

        function submitTest() {
            clearInterval(testTimer);
            clearInterval(questionTimer);
            closeModal();
            exitTestFullscreen();
            
            // Calculate results
            let correctAnswers = 0;
            let incorrectAnswers = 0;
            let score = 0;
            
            currentTest.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer === question.correct) {
                    correctAnswers++;
                    score += currentTest.positiveMarks;
                } else if (userAnswer !== undefined) {
                    incorrectAnswers++;
                    score -= currentTest.negativeMarks;
                }
            });
            
            const totalMarks = currentTest.questions.length * currentTest.positiveMarks;
            const percentage = Math.round((score / totalMarks) * 100);
            
            // Save result
            const result = {
                testId: currentTest.id,
                title: currentTest.title,
                score: Math.max(0, score),
                totalMarks,
                percentage: Math.max(0, percentage),
                correct: correctAnswers,
                incorrect: incorrectAnswers,
                unanswered: currentTest.questions.length - correctAnswers - incorrectAnswers,
                answers: {...userAnswers},
                date: new Date().toISOString(),
                forceTimeMode: currentTest.forceTimeMode
            };
            
            testResults.push(result);
            localStorage.setItem('testResults', JSON.stringify(testResults));
            
            // Show results immediately with download options
            showTestResults(result);
            showNotification('Test submitted successfully!', 'success');
        }

        function showTestResults(result) {
            showScreen('results');
            
            const content = document.getElementById('results-content');
            content.innerHTML = `
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2>Test Completed: ${result.title}</h2>
                        <p>Completed on ${new Date(result.date).toLocaleString()}</p>
                        ${result.forceTimeMode ? '<span style="color: var(--warning); font-weight: bold;">Force Time Mode</span>' : ''}
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                            <div style="text-align: center; background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <span style="font-size: 24px; font-weight: bold; color: var(--primary); display: block;">${result.score}/${result.totalMarks}</span>
                                <span style="font-size: 14px; color: var(--muted);">Score</span>
                            </div>
                            <div style="text-align: center; background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <span style="font-size: 24px; font-weight: bold; color: var(--primary); display: block;">${result.percentage}%</span>
                                <span style="font-size: 14px; color: var(--muted);">Percentage</span>
                            </div>
                            <div style="text-align: center; background: var(--success); color: white; padding: 16px; border-radius: 8px;">
                                <span style="font-size: 24px; font-weight: bold; display: block;">${result.correct}</span>
                                <span style="font-size: 14px;">Correct</span>
                            </div>
                            <div style="text-align: center; background: var(--error); color: white; padding: 16px; border-radius: 8px;">
                                <span style="font-size: 24px; font-weight: bold; display: block;">${result.incorrect}</span>
                                <span style="font-size: 14px;">Incorrect</span>
                            </div>
                        </div>
                        
                        <div class="result-actions">
                            <button class="btn btn-primary" onclick="reviewTest('${result.testId}')">Review Answers</button>
                            <button class="download-btn" onclick="downloadResultHTML('${result.testId}')">Download HTML</button>
                            <button class="download-btn" onclick="downloadResultPDF('${result.testId}')">Download PDF</button>
                            <button class="btn btn-secondary" onclick="showScreen('dashboard')">Back to Home</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function downloadResultHTML(testId) {
            const result = testResults.find(r => r.testId == testId);
            const test = savedTests.find(t => t.id == testId);
            
            if (!result || !test) {
                showNotification('Test data not found', 'error');
                return;
            }
            
            const htmlContent = generateResultHTML(result, test);
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${test.title}_Result.html`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('HTML result downloaded', 'success');
        }

        function downloadResultPDF(testId) {
            // Simple text-based PDF for now
            const result = testResults.find(r => r.testId == testId);
            const test = savedTests.find(t => t.id == testId);
            
            if (!result || !test) {
                showNotification('Test data not found', 'error');
                return;
            }
            
            const content = `
TEST RESULT SUMMARY
==================

Test: ${test.title}
Date: ${new Date(result.date).toLocaleString()}
${result.forceTimeMode ? 'Mode: Force Time Mode' : 'Mode: Normal'}

SCORE BREAKDOWN
===============
Score: ${result.score}/${result.totalMarks}
Percentage: ${result.percentage}%
Correct Answers: ${result.correct}
Incorrect Answers: ${result.incorrect}
Unanswered: ${result.unanswered}

Generated by Mock Test Pro
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${test.title}_Result.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('PDF result downloaded (as TXT)', 'success');
        }

        function generateResultHTML(result, test) {
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Result: ${test.title}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #eee; }
        .score-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .score-box { text-align: center; padding: 15px; border-radius: 8px; }
        .score-primary { background: #e3f2fd; color: #1976d2; }
        .score-success { background: #e8f5e8; color: #388e3c; }
        .score-error { background: #ffebee; color: #d32f2f; }
        .question { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .question-header { font-weight: bold; margin-bottom: 10px; }
        .option { padding: 5px 0; }
        .correct { color: #388e3c; font-weight: bold; }
        .incorrect { color: #d32f2f; font-weight: bold; }
        .unattempted { color: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${test.title}</h1>
            <p>Test Result - ${new Date(result.date).toLocaleString()}</p>
            ${result.forceTimeMode ? '<p style="color: #ff9800; font-weight: bold;">Force Time Mode</p>' : ''}
        </div>
        
        <div class="score-grid">
            <div class="score-box score-primary">
                <h2>${result.score}/${result.totalMarks}</h2>
                <p>Total Score</p>
            </div>
            <div class="score-box score-primary">
                <h2>${result.percentage}%</h2>
                <p>Percentage</p>
            </div>
            <div class="score-box score-success">
                <h2>${result.correct}</h2>
                <p>Correct</p>
            </div>
            <div class="score-box score-error">
                <h2>${result.incorrect}</h2>
                <p>Incorrect</p>
            </div>
        </div>
        
        <h3>Question-wise Analysis</h3>
        ${test.questions.map((q, i) => {
            const userAnswer = result.answers[i];
            const isCorrect = userAnswer === q.correct;
            const status = userAnswer === undefined ? 'unattempted' : (isCorrect ? 'correct' : 'incorrect');
            
            return `
            <div class="question">
                <div class="question-header ${status}">
                    Q${i + 1}: ${q.question}
                    <span style="float: right;">${status.toUpperCase()}</span>
                </div>
                ${q.options.map((opt, oi) => {
                    let className = '';
                    if (oi === q.correct) className = 'correct';
                    else if (oi === userAnswer && !isCorrect) className = 'incorrect';
                    
                    return `<div class="option ${className}">
                        ${String.fromCharCode(65 + oi)}. ${opt}
                        ${oi === q.correct ? ' ✓' : ''}
                        ${oi === userAnswer && !isCorrect ? ' ✗ (Your Answer)' : ''}
                    </div>`;
                }).join('')}
            </div>
            `;
        }).join('')}
        
        <div style="text-align: center; margin-top: 30px; color: #666;">
            <p>Generated by Mock Test Pro</p>
        </div>
    </div>
</body>
</html>
            `;
        }

        function reviewTest(testId) {
            const result = testResults.find(r => r.testId == testId);
            const test = savedTests.find(t => t.id == testId);
            
            if (!result || !test) {
                showNotification('Test data not found', 'error');
                return;
            }
            
            let reviewHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2>Review: ${test.title}</h2>
                        <p>Completed on ${new Date(result.date).toLocaleString()}</p>
                        ${result.forceTimeMode ? '<span style="color: var(--warning); font-weight: bold;">Force Time Mode</span>' : ''}
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                <span style="font-size: 16px; font-weight: bold; color: var(--primary); display: block;">${result.score}/${result.totalMarks}</span>
                                <span style="font-size: 12px; color: var(--muted);">Score</span>
                            </div>
                            <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                <span style="font-size: 16px; font-weight: bold; color: var(--primary); display: block;">${result.percentage}%</span>
                                <span style="font-size: 12px; color: var(--muted);">Percentage</span>
                            </div>
                            <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                <span style="font-size: 16px; font-weight: bold; color: var(--primary); display: block;">${result.correct}</span>
                                <span style="font-size: 12px; color: var(--muted);">Correct</span>
                            </div>
                            <div style="text-align: center; background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                <span style="font-size: 16px; font-weight: bold; color: var(--primary); display: block;">${result.incorrect}</span>
                                <span style="font-size: 12px; color: var(--muted);">Incorrect</span>
                            </div>
                        </div>
            `;
            
       // Add each question with review
test.questions.forEach((question, index) => {
    const userAnswer = result.answers[index];
    const isCorrect = userAnswer === question.correct;
    const isAttempted = userAnswer !== undefined;
    
    let statusBadge = '';
    
    if (!isAttempted) {
        statusBadge = '<span style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Unattempted</span>';
    } else if (isCorrect) {
        statusBadge = '<span style="background: var(--success); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Correct</span>';
    } else {
        statusBadge = '<span style="background: var(--error); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Incorrect</span>';
    }
    
    reviewHTML += `
        <div class="card" style="margin-bottom: 20px; border: 2px solid ${isCorrect ? 'var(--success)' : (isAttempted ? 'var(--error)' : 'var(--warning)')}};">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">Question ${index + 1}</h3>
                ${statusBadge}
            </div>
            <div class="card-body">
                <div style="margin-bottom: 16px; font-weight: 500;">${question.question}</div>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
    `;
    
    question.options.forEach((option, optIndex) => {
        let optionStyle = 'padding: 12px; border: 1px solid var(--border); border-radius: 6px; ';
        
        if (optIndex === question.correct) {
            optionStyle += 'background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success);';
        } else if (optIndex === userAnswer && !isCorrect) {
            optionStyle += 'background: rgba(239, 68, 68, 0.1); border-color: var(--error); color: var(--error);';
        } else {
            optionStyle += 'background: var(--card);';
        }
        
        const marker = optIndex === question.correct ? '✓' : (optIndex === userAnswer && !isCorrect ? '✗' : '');
        
        reviewHTML += `
            <div style="${optionStyle}">
                <strong>${String.fromCharCode(65 + optIndex)}.</strong> ${option} 
                ${marker && `<strong style="float: right;">${marker}</strong>`}
                ${optIndex === userAnswer && optIndex !== question.correct ? ' <em>(Your Answer)</em>' : ''}
                ${optIndex === question.correct ? ' <em>(Correct Answer)</em>' : ''}
            </div>
        `;
    });
    
    // Add explanation section
    reviewHTML += `
                </div>
                ${question.explanation ? `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; border-left: 4px solid var(--primary);">
                        <strong style="color: var(--primary);">Explanation:</strong>
                        <div style="margin-top: 4px; color: var(--text);">${question.explanation}</div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
});                 
            reviewHTML += `
                        <div style="display: flex; justify-content: center; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="showScreen('results')">Back to Results</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('results-content').innerHTML = reviewHTML;
        }

        // Screen-specific functions
        function loadMyTests() {
            const content = document.getElementById('my-tests-content');
            
            if (savedTests.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3>No tests created yet</h3>
                        <p style="color: var(--muted); margin-bottom: 20px;">Create your first test to get started</p>
                        <button class="btn btn-primary" onclick="showScreen('upload')">Create Your First Test</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            savedTests.sort((a, b) => new Date(b.created) - new Date(a.created)).forEach(test => {
                const result = testResults.find(r => r.testId === test.id);
                const bestScore = result ? `${result.percentage}%` : 'Not taken';
                const attempts = testResults.filter(r => r.testId === test.id).length;
                
                html += `
                    <div class="card" style="cursor: pointer;" onclick="loadTest(${test.id})">
                        <div class="card-body" style="padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <h3 style="margin: 0 0 8px 0; color: var(--primary);">${test.title}</h3>
                                    <div style="display: flex; gap: 16px; color: var(--muted); font-size: 14px; margin-bottom: 8px;">
                                        <span>📝 ${test.questions.length} questions</span>
                                        <span>⏱️ ${test.duration} min</span>
                                        <span>🎯 Best: ${bestScore}</span>
                                        ${test.forceTimeMode ? '<span style="color: var(--warning);">⚡ Force Time</span>' : ''}
                                    </div>
                                    <div style="color: var(--muted); font-size: 12px;">
                                        Created: ${new Date(test.created).toLocaleDateString()} • Attempts: ${attempts}
                                    </div>
                                </div>
                                <button class="btn btn-danger" style="padding: 8px 12px; font-size: 12px;" onclick="event.stopPropagation(); deleteTest(${test.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        function loadTest(testId) {
            const test = savedTests.find(t => t.id === testId);
            if (!test) {
                showNotification('Test not found', 'error');
                return;
            }
            
            currentTest = test;
            showInstructions();
        }

        function deleteTest(testId) {
            if (!confirm('Are you sure you want to delete this test? This action cannot be undone.')) {
                return;
            }
            
            // Remove test and its results
            savedTests = savedTests.filter(t => t.id !== testId);
            testResults = testResults.filter(r => r.testId !== testId);
            
            localStorage.setItem('mockTests', JSON.stringify(savedTests));
            localStorage.setItem('testResults', JSON.stringify(testResults));
            
            showNotification('Test deleted', 'success');
            loadMyTests();
            updateProfileDisplay(); // Update stats
        }

        function loadResults() {
            const content = document.getElementById('results-content');
            
            if (testResults.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3>No test results yet</h3>
                        <p style="color: var(--muted); margin-bottom: 20px;">Take a test to see your results here</p>
                        <button class="btn btn-primary" onclick="showScreen('upload')">Create and Take a Test</button>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
            
            // Group results by test
            const resultsByTest = {};
            testResults.forEach(result => {
                if (!resultsByTest[result.testId]) {
                    resultsByTest[result.testId] = [];
                }
                resultsByTest[result.testId].push(result);
            });
            
            Object.keys(resultsByTest).forEach(testId => {
                const test = savedTests.find(t => t.id == testId);
                const testTitle = test ? test.title : 'Unknown Test';
                const results = resultsByTest[testId].sort((a, b) => new Date(b.date) - new Date(a.date));
                const bestResult = results.reduce((best, current) => current.percentage > best.percentage ? current : best);
                
                html += `
                    <div class="card">
                        <div class="card-header">
                            <h3 style="margin: 0;">${testTitle}</h3>
                            <p style="margin: 4px 0 0 0; color: var(--muted);">Attempts: ${results.length} • Best: ${bestResult.percentage}%</p>
                        </div>
                        <div class="card-body">
                `;
                
                results.slice(0, 3).forEach(result => { // Show last 3 attempts
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 600;">${result.score}/${result.totalMarks} (${result.percentage}%)</div>
                                <div style="font-size: 12px; color: var(--muted);">${new Date(result.date).toLocaleString()}</div>
                                ${result.forceTimeMode ? '<div style="font-size: 12px; color: var(--warning);">Force Time Mode</div>' : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="reviewTest('${result.testId}')">Review</button>
                                <button class="download-btn" style="padding: 6px 12px;" onclick="downloadResultHTML('${result.testId}')">HTML</button>
                            </div>
                        </div>
                    `;
                });
                
                if (results.length > 3) {
                    html += `<p style="text-align: center; color: var(--muted); font-size: 12px;">... and ${results.length - 3} more attempts</p>`;
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // ================== DASHBOARD FUNCTIONS ==================

// This is the NEW, fully functional block
// ================== DASHBOARD FUNCTIONS ==================
let completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '{}');

function extractTodayScheduleFromHTML(htmlContent, todayDateStr) {
    try {
        // Create a temporary div to parse HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        
        // Look for script tag containing scheduleData
        const scriptTags = tempDiv.querySelectorAll('script');
        let scheduleData = null;
        
        for (let script of scriptTags) {
            const scriptText = script.textContent || script.innerHTML;
            
            // Check if this script contains scheduleData
            if (scriptText.includes('const scheduleData = {')) {
                try {
                    // Extract the scheduleData object
                    const startIndex = scriptText.indexOf('const scheduleData = {');
                    const endIndex = scriptText.indexOf('};', startIndex) + 2;
                    const scheduleDataString = scriptText.substring(startIndex, endIndex);
                    
                    // Create a safe function to evaluate the data
                    const functionBody = scheduleDataString + '; return scheduleData;';
                    scheduleData = new Function(functionBody)();
                    break;
                } catch (error) {
                    console.error('Error parsing schedule data:', error);
                    continue;
                }
            }
        }
        
        if (!scheduleData) {
            console.log('No scheduleData found in HTML');
            return null;
        }
        
        console.log('Available dates in schedule:', Object.keys(scheduleData));
        console.log('Looking for date:', todayDateStr);
        
        // Check if today's date exists in schedule
        const todaySchedule = scheduleData[todayDateStr];
        if (todaySchedule && todaySchedule.subjects) {
            console.log('Found schedule for today:', todaySchedule);
            return generateScheduleHTML(todaySchedule, todayDateStr);
        } else {
            console.log('No schedule found for date:', todayDateStr);
            return null;
        }
        
    } catch (error) {
        console.error('Error extracting schedule from HTML:', error);
        return null;
    }
}

function generateScheduleHTML(todaySchedule, dateStr) {
    const subjects = todaySchedule.subjects || [];
    
    let html = `
        <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem; border-left: 4px solid var(--primary);">
            <h3 style="margin: 0 0 0.5rem 0; color: var(--primary);">${todaySchedule.week}</h3>
            <p style="margin: 0; color: var(--muted); font-size: 0.875rem;">
                ${subjects.length} subjects planned for today
            </p>
        </div>
    `;
    
    subjects.forEach((subject, index) => {
        const isCompleted = isTaskCompleted(dateStr, index);
        html += `
            <div class="schedule-entry" style="position: relative; opacity: ${isCompleted ? '0.7' : '1'};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div class="schedule-time">${subject.title}</div>
                            <span style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem;">${subject.duration}</span>
                        </div>
                        <div style="color: var(--muted); font-size: 0.85rem; line-height: 1.4; white-space: pre-line; ${isCompleted ? 'text-decoration: line-through;' : ''}">${subject.details}</div>
                    </div>
                    <div style="display: flex; align-items: center; flex-shrink: 0; margin-left: 1rem;">
                        <button class="btn ${isCompleted ? 'btn-secondary' : 'btn-success'}" 
                                onclick="markTaskComplete('${dateStr}', ${index})" 
                                style="padding: 0.375rem 1rem; font-size: 0.75rem; white-space: nowrap;">
                            ${isCompleted ? 'Completed ✓' : 'Mark Done'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += generateDayStats(dateStr);
    return html;
}

// This is the NEW, improved function
function loadTodaysSchedule() {
    const container = document.getElementById('todays-schedule');
    if (!container) return;
    
    // Get today's date in IST
    const today = new Date();
    const todayIST = new Date(today.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
    const todayDateStr = formatDateForSchedule(todayIST);
    
    console.log('Today\'s date:', todayDateStr);
    
    // Check if we have imported HTML timetable
    const savedHTML = localStorage.getItem('htmlTimetable');
    if (savedHTML) {
        console.log('Found saved HTML timetable');
        const todayScheduleFromHTML = extractTodayScheduleFromHTML(savedHTML, todayDateStr);
        if (todayScheduleFromHTML) {
            container.innerHTML = todayScheduleFromHTML;
            return;
        } else {
            console.log('No schedule found for today in HTML timetable');
        }
    } else {
        console.log('No HTML timetable found in localStorage');
    }
    
    // Fallback to manual entries
    const todayEntries = schedule.filter(entry => {
        if (entry.date === todayDateStr) return true;
        const entryDay = entry.day ? entry.day.toLowerCase() : '';
        const todayDay = todayIST.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
        return entryDay === todayDay;
    });
    
    console.log('Manual entries found:', todayEntries.length);
    
    if (todayEntries.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                <h3 style="color: var(--text); margin-bottom: 1rem;">No schedule for today (${todayDateStr})</h3>
                <p style="color: var(--muted); margin-bottom: 1rem;">Import a schedule or add manual entries to see today's plan</p>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showScreen('timetable')" style="padding: 0.5rem 1rem;">Add Schedule</button>
                    <button class="btn btn-secondary" onclick="importSchedule()" style="padding: 0.5rem 1rem;">Import Schedule</button>
                </div>
            </div>
        `;
        return;
    }
    // ADD THIS NEW FUNCTION
function deleteScheduleEntry(index) {
    if (index >= 0 && index < schedule.length) {
        if (confirm('Are you sure you want to delete this schedule entry?')) {
            schedule.splice(index, 1);
            localStorage.setItem('schedule', JSON.stringify(schedule));
            showNotification('Schedule entry deleted', 'success');
            loadTodaysSchedule(); // Refresh the display
        }
    }
}

    
    // Display manual entries
    todayEntries.sort((a, b) => (a.startTime || a.time || '').localeCompare(b.startTime || b.time || ''));
    
    let html = '';
    todayEntries.forEach((entry, index) => {
        html += `
            <div class="schedule-entry" style="position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div class="schedule-time">${entry.startTime || entry.time || 'All Day'} ${entry.endTime ? '- ' + entry.endTime : ''}</div>
                        <div style="font-weight: 600; margin: 0.5rem 0; color: var(--primary);">${entry.subject || entry.title || 'Untitled'}</div>
                        ${entry.notes ? `<div style="color: var(--muted); font-size: 0.875rem;">${entry.notes}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0; margin-left: 1rem;">
                        <button class="btn ${isTaskCompleted(todayDateStr, index) ? 'btn-secondary' : 'btn-success'}" 
                                onclick="markTaskComplete('${todayDateStr}', index)" 
                                style="padding: 0.25rem 0.75rem; font-size: 0.75rem; white-space: nowrap;">
                            ${isTaskCompleted(todayDateStr, index) ? 'Completed ✓' : 'Mark Done'}
                        </button>
                        <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" 
                                onclick="deleteScheduleEntry(${schedule.indexOf(entry)})">×</button>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html + generateDayStats(todayDateStr);
}

// This is the NEW, corrected function
function formatDateForSchedule(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}


function isTaskCompleted(dateStr, taskIndex) {
    return completedTasks[dateStr] && completedTasks[dateStr][taskIndex];
}

function markTaskComplete(dateStr, taskIndex) {
    if (!completedTasks[dateStr]) {
        completedTasks[dateStr] = {};
    }
    
    if (completedTasks[dateStr][taskIndex]) {
        delete completedTasks[dateStr][taskIndex];
        showNotification('Task marked as incomplete', 'warning');
    } else {
        completedTasks[dateStr][taskIndex] = {
            completedAt: new Date().toISOString(),
            completed: true
        };
        showNotification('Task completed! Great job!', 'success');
    }
    
    localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
    loadTodaysSchedule();
}

function generateDayStats(dateStr) {
    const completedCount = getCompletedTasksForDate(dateStr);
    const totalCount = getTotalTasksForDate(dateStr);
    const completionPercentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
    
    return `
        <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; color: var(--text);">Today's Progress</h4>
                <span style="color: var(--primary); font-weight: 600;">${completionPercentage}%</span>
            </div>
            <div style="background: var(--border); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 1rem;">
                <div style="background: var(--success); height: 100%; width: ${completionPercentage}%; transition: width 0.3s ease;"></div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${completedCount}</div>
                    <div style="font-size: 0.75rem; color: var(--muted);">Completed</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${totalCount - completedCount}</div>
                    <div style="font-size: 0.75rem; color: var(--muted);">Remaining</div>
                </div>
                <div>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${totalCount}</div>
                    <div style="font-size: 0.75rem; color: var(--muted);">Total</div>
                </div>
            </div>
        </div>
    `;
}
// ADD this new function
function toggleScheduleView() {
    const scheduleContainer = document.getElementById('todays-schedule');
    const toggleIcon = document.getElementById('schedule-toggle-icon');
    const toggleText = document.getElementById('schedule-toggle-text');
    
    if (scheduleContainer.classList.contains('schedule-expanded')) {
        scheduleContainer.classList.remove('schedule-expanded');
        scheduleContainer.classList.add('schedule-collapsed');
        toggleIcon.textContent = '👁️';
        toggleText.textContent = 'Expand';
    } else {
        scheduleContainer.classList.remove('schedule-collapsed');
        scheduleContainer.classList.add('schedule-expanded');
        toggleIcon.textContent = '🙈';
        toggleText.textContent = 'Collapse';
    }
}


function getCompletedTasksForDate(dateStr) {
    if (!completedTasks[dateStr]) return 0;
    return Object.keys(completedTasks[dateStr]).length;
}

function getTotalTasksForDate(dateStr) {
    // Check HTML timetable first
    const savedHTML = localStorage.getItem('htmlTimetable');
    if (savedHTML) {
        try {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = savedHTML;
            const scriptContent = tempDiv.querySelector('script');
            
            if (scriptContent) {
                const scriptText = scriptContent.textContent;
                const scheduleDataMatch = scriptText.match(/const scheduleData = ({[\s\S]*?});/);
                
                if (scheduleDataMatch) {
                    const scheduleDataStr = scheduleDataMatch[1];
                    const scheduleData = new Function('return ' + scheduleDataStr)();
                    const todaySchedule = scheduleData[dateStr];
                    
                    if (todaySchedule && todaySchedule.subjects) {
                        return todaySchedule.subjects.length;
                    }
                }
            }
        } catch (error) {
            console.error('Error parsing schedule data:', error);
        }
    }
    
    // Fallback to manual entries
    const today = new Date(dateStr + 'T00:00:00');
    const dayName = today.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
    return schedule.filter(entry => 
        entry.date === dateStr || 
        (entry.day && entry.day.toLowerCase() === dayName)
    ).length;
}

// ================== END DASHBOARD FUNCTIONS ==================

     // Schedule functions
function loadTimetable() {
    const list = document.getElementById('timetable-list');
    
    if (!Array.isArray(schedule) || schedule.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <p style="color: var(--muted);">No schedule items yet.</p>
                <p style="color: var(--muted); font-size: 12px;">Add items manually or import an HTML schedule.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
    
    // Group by date
    const scheduleByDate = {};
    schedule.forEach(item => {
        if (!scheduleByDate[item.date]) {
            scheduleByDate[item.date] = [];
        }
        scheduleByDate[item.date].push(item);
    });
    
    // Sort dates chronologically
    const sortedDates = Object.keys(scheduleByDate).sort((a, b) => new Date(a) - new Date(b));
    
    sortedDates.forEach(date => {
        const items = scheduleByDate[date];
        const totalTime = items.reduce((sum, item) => sum + (parseInt(item.time) || 0), 0);
        const hours = Math.floor(totalTime / 60);
        const minutes = totalTime % 60;
        
        html += `
            <div class="card">
                <div class="card-header">
                    <h3 style="margin: 0;">${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                    <p style="margin: 4px 0 0 0; color: var(--muted);">Total: ${hours > 0 ? `${hours}h ` : ''}${minutes}m</p>
                </div>
                <div class="card-body">
        `;
        
        items.forEach((item, index) => {
            html += `
                <div class="schedule-item">
                    <div class="schedule-title">${item.subject || 'Untitled'}</div>
                    <div style="color: var(--muted); font-size: 14px;">
                        ${item.time || '0'} minutes
                        <button style="float: right; background: var(--error); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" onclick="deleteScheduleItem('${date}', ${index})">Delete</button>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    list.innerHTML = html;
}

function addTimetableItem() {
    const date = document.getElementById('timetable-date').value;
    const subject = document.getElementById('timetable-subject').value.trim();
    const time = parseInt(document.getElementById('timetable-time').value);
    
    if (!date || !subject || !time || isNaN(time) || time <= 0) {
        showNotification('Please fill all fields with valid values', 'error');
        return;
    }
    
    // Ensure schedule is an array
    if (!Array.isArray(schedule)) {
        schedule = [];
    }
    
    schedule.push({
        date,
        subject,
        time
    });
    
    localStorage.setItem('schedule', JSON.stringify(schedule));
    showNotification('Item added to schedule', 'success');
    
    // Clear form
    document.getElementById('timetable-subject').value = '';
    document.getElementById('timetable-time').value = '';
    
    loadTimetable();
}

function deleteScheduleItem(date, index) {
    if (!confirm('Are you sure you want to delete this schedule item?')) {
        return;
    }
    
    // Find all items with this date
    const dateItems = schedule.filter(item => item.date === date);
    
    if (index >= 0 && index < dateItems.length) {
        const itemToDelete = dateItems[index];
        const globalIndex = schedule.indexOf(itemToDelete);
        
        if (globalIndex > -1) {
            schedule.splice(globalIndex, 1);
            localStorage.setItem('schedule', JSON.stringify(schedule));
            showNotification('Schedule item deleted', 'success');
            loadTimetable();
        }
    } else {
        showNotification('Error deleting schedule item', 'error');
    }
}

function importSchedule() {
    openModal('schedule-import-modal');
}

// This is the NEW, corrected function
function importScheduleHTML() {
    const htmlContent = document.getElementById('schedule-html').value.trim();
    
    if (!htmlContent) {
        showNotification('Please paste schedule HTML content', 'error');
        return;
    }
    
    try {
        const styledHTML = applyAppStyling(htmlContent);
        localStorage.setItem('htmlTimetable', styledHTML);
        
        closeModal();
        showNotification('Schedule imported successfully!', 'success');
        loadTodaysSchedule(); // Refresh today's display
        
    } catch (error) {
        showNotification('Error importing schedule: ' + error.message, 'error');
    }
}

// This is your CURRENT function
function applyAppStyling(htmlCode) {
    return `
        <style>
            .app-timetable-wrapper {
                font-family: system-ui, -apple-system, sans-serif !important;
                background: var(--card) !important;
                color: var(--text) !important;
                border-radius: 0.75rem !important;
                overflow: hidden !important;
                padding: 1rem;
                margin: 1rem 0;
            }
            .app-timetable-wrapper table {
                width: 100% !important;
                border-collapse: collapse !important;
            }
            .app-timetable-wrapper th,
            .app-timetable-wrapper td {
                border: 1px solid var(--border) !important;
                padding: 0.5rem !important;
                text-align: left !important;
            }
            .app-timetable-wrapper th {
                background-color: var(--primary) !important;
                color: white !important;
            }
            .app-timetable-wrapper tr:nth-child(even) {
                background-color: var(--bg-secondary) !important;
            }
        </style>
        <div class="app-timetable-wrapper">
            ${htmlCode}
        </div>
    `;
}

// This is the NEW, improved function
function applyAppStyling(htmlCode) {
    return `
        <style>
            .app-timetable-wrapper {
                font-family: system-ui, -apple-system, sans-serif !important;
                background: var(--card) !important;
                color: var(--text) !important;
                border-radius: 0.75rem !important;
                overflow: hidden !important;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
            }
            
            .app-timetable-wrapper .container {
                background: var(--card) !important;
                color: var(--text) !important;
                padding: 1rem !important;
                margin: 0 !important;
                max-width: 100% !important;
            }
            
            .app-timetable-wrapper .header h1 {
                color: var(--primary) !important;
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
                text-align: center !important;
            }
        </style>
        <div class="app-timetable-wrapper">
            ${htmlCode}
        </div>
    `;
}

function extractScheduleDataFromHTML(htmlContent) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    
    // Look for script content with schedule data
    const scriptContent = tempDiv.querySelector('script');
    if (scriptContent) {
        try {
            const scriptText = scriptContent.textContent;
            const scheduleDataMatch = scriptText.match(/const scheduleData = ({[\s\S]*?});/);
            
            if (scheduleDataMatch) {
                const scheduleDataStr = scheduleDataMatch[1];
                return new Function('return ' + scheduleDataStr)();
            }
        } catch (error) {
            console.error('Error parsing schedule data:', error);
        }
    }
    return null;
}

// Add this helper function to extract text content from HTML
function extractTextFromHTML(html) {
    const div = document.createElement('div');
    div.innerHTML = html;
    return div.textContent || div.innerText || '';
}   

        // Notes functions
        function loadNotes() {
            const list = document.getElementById('notes-list');
            
            if (notes.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p style="color: var(--muted);">No notes created yet.</p>
                        <p style="color: var(--muted); font-size: 12px;">Create your first note to get started.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            notes.forEach((note, index) => {
                html += `
                    <div class="note-item" onclick="openNote(${index})">
                        <div class="note-title">${note.title}</div>
                        <div style="color: var(--muted); font-size: 12px; margin-top: 4px;">
                            Created: ${new Date(note.date).toLocaleString()}
                            <button style="float: right; background: var(--error); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;" onclick="event.stopPropagation(); deleteNote(${index})">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            list.innerHTML = html;
        }

        function createNote() {
            const modal = document.getElementById('note-creation-modal');
            modal.classList.add('show');
        }

        function saveNote() {
            const title = document.getElementById('note-title').value.trim();
            const html = document.getElementById('note-html').value.trim();
            
            if (!title || !html) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            
            notes.push({
                title,
                html,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('notes', JSON.stringify(notes));
            showNotification('Note saved successfully', 'success');
            
            // Clear form
            document.getElementById('note-title').value = '';
            document.getElementById('note-html').value = '';
            
            closeModal();
            loadNotes();
        }

        function openNote(index) {
            const note = notes[index];
            
            // Create a new window/tab with the HTML content
            const newWindow = window.open('', '_blank');
            newWindow.document.open();
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${note.title}</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        h1, h2, h3 { color: #333; }
                        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; }
                        code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>${note.title}</h1>
                    <hr>
                    ${note.html}
                    <hr>
                    <p style="color: #666; font-size: 12px;">Created: ${new Date(note.date).toLocaleString()}</p>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        function deleteNote(index) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }
            
            notes.splice(index, 1);
            localStorage.setItem('notes', JSON.stringify(notes));
            showNotification('Note deleted', 'success');
            loadNotes();
        }



        // Profile functions
        function changeProfilePicture() {
            document.getElementById('avatar-input').click();
        }

        function updateProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            
            if (!name) {
                showNotification('Please enter your name', 'error');
                return;
            }
            
            userProfile.name = name;
            userProfile.bio = bio;
            
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            showNotification('Profile updated successfully', 'success');
        }

        // Force Time Mode functions
        function startQuestionTimer() {
            if (!currentTest.forceTimeMode) return;
            
            const forcedTime = getForcedTimeMinutes();
questionTimeRemaining = (forcedTime !== null) ? forcedTime * 60 : 120;
            clearInterval(questionTimer);
            
            const timerElement = document.getElementById('question-timer');
            timerElement.style.display = 'block';
            
            questionTimer = setInterval(() => {
                if (isPaused || questionLocked) return;
                
                questionTimeRemaining--;
                updateQuestionTimerDisplay();
                
                if (questionTimeRemaining <= 0) {
                    lockCurrentQuestion();
                    setTimeout(() => {
                        if (currentQuestion < currentTest.questions.length - 1) {
                            currentQuestion++;
                            questionLocked = false;
                            loadCurrentQuestion();
                        } else {
                            autoSubmitTest();
                        }
                    }, 1000);
                }
            }, 1000);
        }

        function updateQuestionTimerDisplay() {
            const minutes = Math.floor(questionTimeRemaining / 60);
            const seconds = questionTimeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('question-timer').textContent = display;
            
            const timerEl = document.getElementById('question-timer');
            if (questionTimeRemaining <= 30) {
                timerEl.classList.add('warning');
            }
        }

        function lockCurrentQuestion() {
            questionLocked = true;
            document.getElementById('question-container').classList.add('question-expired');
            document.querySelectorAll('.option-item').forEach(item => {
                item.style.pointerEvents = 'none';
                item.style.opacity = '0.5';
            });
            
            showNotification('Time expired! Moving to next question...', 'warning');
        }

        // Auto-submit functionality
        function setupAutoSubmit() {
            // Auto-submit on page unload/refresh
            window.addEventListener('beforeunload', (e) => {
                if (currentTest && document.getElementById('test-screen').classList.contains('active')) {
                    autoSubmitTest();
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Auto-submit on visibility change (tab switch)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && currentTest && document.getElementById('test-screen').classList.contains('active')) {
                    showNotification('Tab switched detected. Auto-submitting test...', 'warning');
                    setTimeout(() => {
                        autoSubmitTest();
                    }, 2000);
                }
            });
        }

        function submitTest() {  
    clearInterval(testTimer);  
    clearInterval(questionTimer);  
    closeModal();  
    exitTestFullscreen();  
      
    // Calculate results  
    let correctAnswers = 0;  
    let incorrectAnswers = 0;  
    let score = 0;  
      
    currentTest.questions.forEach((question, index) => {  
        const userAnswer = userAnswers[index];  
        if (userAnswer === question.correct) {  
            correctAnswers++;  
            score += currentTest.positiveMarks;  
        } else if (userAnswer !== undefined) {  
            incorrectAnswers++;  
            score -= currentTest.negativeMarks;  
        }  
    });  
      
    const totalMarks = currentTest.questions.length * currentTest.positiveMarks;  
    const percentage = Math.round((score / totalMarks) * 100);  
      
    // Save result  
    const result = {  
        testId: currentTest.id,  
        title: currentTest.title,  
        score: Math.max(0, score),  
        totalMarks,  
        percentage: Math.max(0, percentage),  
        correct: correctAnswers,  
        incorrect: incorrectAnswers,  
        unanswered: currentTest.questions.length - correctAnswers - incorrectAnswers,  
        answers: {...userAnswers},  
        date: new Date().toISOString(),  
        forceTimeMode: currentTest.forceTimeMode || false  
    };  
      
    testResults.push(result);  
    localStorage.setItem('testResults', JSON.stringify(testResults));  
      
    // Show results immediately  
    showTestResults(result);  
    showNotification('Test submitted successfully!', 'success');  
}
        // Download functions
        function downloadResultHTML(testId) {
            const result = testResults.find(r => r.testId == testId);
            const test = savedTests.find(t => t.id == testId);
            
            if (!result || !test) {
                showNotification('Test data not found', 'error');
                return;
            }
            
            const htmlContent = generateResultHTML(result, test);
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${test.title.replace(/[^a-z0-9]/gi, '_')}_Result.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showNotification('HTML result downloaded', 'success');
        }

        function downloadResultPDF(testId) {
            // For now, create a simple text file since PDF generation requires additional libraries
            const result = testResults.find(r => r.testId == testId);
            const test = savedTests.find(t => t.id == testId);
            
            if (!result || !test) {
                showNotification('Test data not found', 'error');
                return;
            }
            
            const content = `
TEST RESULT SUMMARY
==================
Test: ${test.title}
Date: ${new Date(result.date).toLocaleString()}
Duration: ${test.duration} minutes
${result.autoSubmitted ? 'Status: Auto-submitted' : 'Status: Manual submission'}

SCORE BREAKDOWN
===============
Score: ${result.score}/${result.totalMarks}
Percentage: ${result.percentage}%
Correct Answers: ${result.correct}
Incorrect Answers: ${result.incorrect}
Unanswered: ${result.unanswered}

QUESTION ANALYSIS
=================
${test.questions.map((q, i) => {
    const userAnswer = result.answers[i];
    const status = userAnswer === q.correct ? 'CORRECT' : 
                   userAnswer !== undefined ? 'INCORRECT' : 'UNANSWERED';
    
    return `Q${i + 1}: ${status}
Question: ${q.question}
Your Answer: ${userAnswer !== undefined ? q.options[userAnswer] : 'Not answered'}
Correct Answer: ${q.options[q.correct]}
${status === 'INCORRECT' || status === 'UNANSWERED' ? `Marks Lost: ${status === 'INCORRECT' ? test.negativeMarks : 0}` : `Marks Gained: ${test.positiveMarks}`}
`;
}).join('\n')}

Generated by Mock Test Pro
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${test.title.replace(/[^a-z0-9]/gi, '_')}_Result.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            showNotification('Result downloaded as text file', 'success');
        }

        function generateResultHTML(result, test) {
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Result: ${test.title}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #06b6d4; }
        .header h1 { color: #06b6d4; margin-bottom: 10px; }
        .score-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0; }
        .score-box { text-align: center; padding: 20px; border-radius: 10px; border: 2px solid; }
        .score-primary { background: #e0f7ff; border-color: #06b6d4; color: #0369a1; }
        .score-success { background: #dcfce7; border-color: #10b981; color: #059669; }
        .score-error { background: #fef2f2; border-color: #ef4444; color: #dc2626; }
        .score-value { font-size: 28px; font-weight: bold; display: block; margin-bottom: 5px; }
        .score-label { font-size: 14px; font-weight: 600; }
        .question { margin: 25px 0; padding: 20px; border: 2px solid #e5e7eb; border-radius: 12px; background: #fafafa; }
        .question-header { font-weight: bold; margin-bottom: 15px; font-size: 16px; color: #374151; }
        .option { padding: 10px 15px; margin: 8px 0; border-radius: 8px; border: 1px solid #d1d5db; }
        .correct { background: #dcfce7; border-color: #10b981; color: #059669; font-weight: 600; }
        .incorrect { background: #fef2f2; border-color: #ef4444; color: #dc2626; font-weight: 600; }
        .unattempted { background: #fef3c7; border-color: #f59e0b; color: #d97706; }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white; }
        .status-correct { background: #10b981; }
        .status-incorrect { background: #ef4444; }
        .status-unattempted { background: #f59e0b; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #e5e7eb; color: #6b7280; }
        @media print { body { background: white; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${test.title}</h1>
            <p style="font-size: 16px; color: #6b7280;">Test Result - ${new Date(result.date).toLocaleString()}</p>
            <p style="font-size: 14px; color: #6b7280;">Duration: ${test.duration} minutes | Questions: ${test.questions.length}</p>
            ${result.autoSubmitted ? '<p style="color: #f59e0b; font-weight: bold;">⚠️ Auto-submitted due to inactivity</p>' : ''}
        </div>
        
        <div class="score-grid">
            <div class="score-box score-primary">
                <span class="score-value">${result.score}/${result.totalMarks}</span>
                <span class="score-label">Total Score</span>
            </div>
            <div class="score-box score-primary">
                <span class="score-value">${result.percentage}%</span>
                <span class="score-label">Percentage</span>
            </div>
            <div class="score-box score-success">
                <span class="score-value">${result.correct}</span>
                <span class="score-label">Correct Answers</span>
            </div>
            <div class="score-box score-error">
                <span class="score-value">${result.incorrect}</span>
                <span class="score-label">Incorrect Answers</span>
            </div>
        </div>
        
        <h3>Question-wise Analysis</h3>
${test.questions.map((q, i) => {
    const userAnswer = result.answers[i];
    const isCorrect = userAnswer === q.correct;
    const status = userAnswer === undefined ? 'unattempted' : (isCorrect ? 'correct' : 'incorrect');
    
    return `
    <div class="question">
        <div class="question-header ${status}">
            Q${i + 1}: ${q.question}
            <span style="float: right;">${status.toUpperCase()}</span>
        </div>
        ${q.options.map((opt, oi) => {
            let className = '';
            if (oi === q.correct) className = 'correct';
            else if (oi === userAnswer && !isCorrect) className = 'incorrect';
            
            return `<div class="option ${className}">
                ${String.fromCharCode(65 + oi)}. ${opt}
                ${oi === q.correct ? ' ✓' : ''}
                ${oi === userAnswer && !isCorrect ? ' ✗ (Your Answer)' : ''}
            </div>`;
        }).join('')}
        ${q.explanation ? `
            <div style="background: #f0f9ff; padding: 10px; margin-top: 10px; border-left: 4px solid #0369a1; border-radius: 4px;">
                <strong style="color: #0369a1;">Explanation:</strong>
                <p style="margin: 4px 0 0 0; color: #374151;">${q.explanation}</p>
            </div>
        ` : ''}
    </div>
    `;
}).join('')}
        
        <div class="footer">
            <p><strong>Mock Test Pro</strong> - Your Ultimate Test Practice Platform</p>
            <p>Generated on ${new Date().toLocaleString()}</p>
        </div>
    </div>
</body>
</html>
            `;
        }

        // Copy sample JSON function
        function copySampleJSON() {
            const sampleJSON = `[
  {
    "question": "Identify the segment that contains a grammatical error: Everybody stared / when me / entered the / drawing room.",
    "options": ["Everybody stared", "when me", "entered the", "drawing room"],
    "correct": 1,
    "explanation": "The pronoun 'me' is in the objective case and is used when it is the object of a verb or preposition. Here, the pronoun is the subject of the verb 'entered'. Therefore, the subjective case pronoun 'I' should be used instead. The correct sentence is: 'Everybody stared when I entered the drawing room.'"
  },
  {
    "question": "Select the most appropriate option to substitute the underlined segment: <u>Whom</u> was the person that you wanted me to contact there?",
    "options": ["Who was the person", "Whom was the person", "Which was the person", "Whose was the person"],
    "correct": 0,
    "explanation": "'Who' is a subjective pronoun used to refer to the subject of a sentence. 'Whom' is an objective pronoun used to refer to the object of a verb or preposition. In this question, 'the person' is the subject, so the correct pronoun is 'Who'."
  },
  {
    "question": "Select the most appropriate ANTONYM of the given word: Generous",
    "options": ["Kind", "Charitable", "Selfish", "Liberal"],
    "correct": 2,
    "explanation": "Generous means willing to give more of something than is expected. Selfish means concerned chiefly with one's own personal profit or pleasure, which is the direct opposite."
  },
  {
    "question": "Select the INCORRECTLY spelt word.",
    "options": ["Accommodate", "Separate", "Occasion", "Neccessary"],
    "correct": 3,
    "explanation": "The correct spelling is 'necessary' (one 'c', double 's')."
  },
  {
    "question": "Pintu has been advised to _________ smoking by his family doctor.",
    "options": ["give up", "cut off", "cut down", "give in"],
    "correct": 2,
    "explanation": "The phrasal verb 'cut down' means to reduce the amount or quantity of something. This fits the context of reducing smoking."
  }
]`;
            
            navigator.clipboard.writeText(sampleJSON).then(() => {
                showNotification('Sample JSON copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = sampleJSON;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('Sample JSON copied!', 'success');
            });
        }
// ================= Utility Functions =================

// Copy to clipboard (used in AI Notes Prompt Helper)
function copyToClipboard(selector) {
    const element = document.querySelector(selector);
    const text = element ? (element.value || element.textContent) : '';
    if (!text) {
        showNotification('Nothing to copy', 'warning');
        return;
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Copied to clipboard!', 'success');
        }).catch(() => {
            showNotification('Copy failed', 'error');
        });
    } else {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showNotification('Copied (fallback)', 'success');
    }
}

// Global notification system
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const text = document.getElementById('notification-text');

    if (!notification || !text) {
        console.error('Notification elements not found');
        return;
    }

    if (window.notificationTimeout) clearTimeout(window.notificationTimeout);

    text.textContent = message;
    notification.className = `notification ${type} show`;

    window.notificationTimeout = setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            setupAutoSubmit();
        });
        
    </script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const checkbox = document.getElementById('force-time-mode');
    const minutesInput = document.getElementById('force-time-minutes');

    if (checkbox && minutesInput) {
        checkbox.addEventListener('change', () => {
            minutesInput.disabled = !checkbox.checked;
        });
    }
});

// Use this function when starting the test to get the value:
function getForcedTimeMinutes() {
    const checkbox = document.getElementById('force-time-mode');
    const minutesInput = document.getElementById('force-time-minutes');
    if (checkbox && checkbox.checked && minutesInput) {
        const val = parseInt(minutesInput.value, 10);
        if (!isNaN(val) && val >= 1 && val <= 10) {
            return val;
        }
    }
    return null; // not forced
}
</script>
</body>
</html> 